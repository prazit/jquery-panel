<!DOCTYPE html>
<html>

<head>
    <title>Analog Clock using focus-3.html</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="focus-3.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/sym-fa.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/ani-anicss.css"/>
    <style>
        @keyframes ani-clock {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .ani-clock {
            -webkit-animation-name: ani-clock;
            animation-name: ani-clock;
        }

        @keyframes ani-hide-circle-progress {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -31.415926535897932384626433832795;
            }
        }

        .ani-hide-circle-progress {
            -webkit-animation-name: ani-hide-circle-progress;
            animation-name: ani-hide-circle-progress;
            animation-timing-function: linear;
        }

        .cover {
            position: absolute;
            width: 100vh;
            height: 100vh;
            left: calc((100vw - 100vh) / 2);
        }

        .clock {
            position: absolute;
            width: 100vh;
            height: 100vh;
            display: none;
        }

        .css-trans {
            transition-duration: 0.2s;
        }
    </style>
</head>

<body class="css-trans fixed background--c0 fit-width fit-height" style="font-family: Arial,sans-serif;">

<!-- clock -->
<div class="cover">
    <!-- this content will be replaced by clock -->
</div>

<!-- filter -->
<div class="out-side fixed fit-width fit-height">
    <h1 class="on-top footprint padding--x10 opacity--x0 opacity--x100--at">Analogue Clock v1</h1>
</div>

<!-- ticker -->
<div class="on-top-right padding--x5 hidden">
    <span class="text--c3 text--x2 ticker"></span>
</div>

<!-- animation selector -->
<div class="on-top-left css-trans opacity--x0 opacity--x100--at margin--x20" style="display: inline-block">
    <div class="rounded--x50 center-text">
        <span class="analogue-move button left-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at" title="count up to max">Analogue Move</span>
        <span class="smooth-move button right-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at" title="count up to last-max and increase last-max every loop">Smooth Move</span>
    </div>
</div>

<!-- clocks & backgrounds -->
<div class="css-trans on-bottom-left columns opacity--x0 opacity--x100--at">
    <!-- backgrounds -->
    <div class="column-1-2">
        <div class="backgrounds margin--x10 rounded--x20 border--x4 border--c3">
            <span class="background-list top-child background--c3 opacity--x70 padding--x10 center-text">Backgrounds</span>
            <div class="background-container">
                <span class="background-item button child background--c1 background--c0--at padding--x10 left-text">background-name</span>
            </div>
            <span class="auto-change-background bottom-child button background--c3 background--c0--at opacity--x70 padding--x10 center-text">Auto Change</span>
        </div>
    </div>

    <!-- clocks -->
    <div class="column-1-2">
        <div class="clocks margin--x10 rounded--x20 border--x4 border--c3">
            <span class="clock-list top-child background--c3 opacity--x70 padding--x10 center-text">Clocks</span>
            <div class="clock-container">
                <span class="clock-item button child background--c1 background--c0--at padding--x10 left-text">clock-name</span>
            </div>
            <span class="bottom-child background--c1 padding--x10 center-text"></span>
        </div>
    </div>
</div>

<!-- colors -->
<div class="css-trans on-top-right theme margin--x10 opacity--x0 opacity--x100--at columns">
    <div class="column-1-2">
        <div class="rounded--x20 border--x4 border--c3 colors">
            <span class="profile-name button top-child background--c3 background--c0--at opacity--x70 padding--x10 center-text">Profile</span>
            <span class="color-handSecond button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Second Hand</span>
            <span class="color-handMinute button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minute Hand</span>
            <span class="color-handHour button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Hour Hand</span>
            <span class="color-numbers button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Numbers</span>
            <span class="color-minutes button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minutes</span>
            <span class="color-fiveMinutes button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Five Minutes</span>
            <span class="color-frame button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Frame</span>
            <span class="color-background button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Background</span>
            <span class="color-outSide button bottom-child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Outside</span>
        </div>
    </div>
    <div class="column-1-2">
        <div class="rounded--x20 border--x4 border--c3">
            <span class="profile-list top-child background--c3 opacity--x70 padding--x10 center-text">Themes</span>
            <div class="profile-container">
                <span class="profile button child background--c1 background--c0--at padding--x10 left-text">profile-name</span>
            </div>
            <span class="add-profile button bottom-child background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
        </div>
    </div>
</div>

<!-- combination -->
<div class="combinations css-trans on-bottom-right margin--x10 opacity--x0 opacity--x100--at rounded--x20 border--x4 border--c3">
    <span class="combination-list top-child background--c3 opacity--x70 padding--x10 center-text">Presets</span>
    <div class="combination-container">
        <span class="combination-item button child background--c1 background--c0--at padding--x10 left-text">combination-name</span>
    </div>
    <span class="add-combination bottom-child button background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
</div>

<!-- input -->
<div class="input-panel opacity--x0" style="overflow:hidden;max-width:0px;">
    <label>Please enter value:</label>
    <input type="text" value="10" class="text--c0 width--fit"/>
</div>
<div class="seenmove-panel opacity--x0" style="overflow:hidden;max-width:0px;">
    <div class="columns width--fit">
        <div class="column-1-2">
            <label class="label-x">X value:</label>
        </div>
        <div class="column-1-2">
            <label class="label-y">Y value:</label>
        </div>
    </div>
    <div class="columns width--fit">
        <div class="column-1-2">
            <input class="input-x" type="number" value="0" class="text--c0 width--fit"/>
        </div>
        <div class="column-1-2">
            <input class="input-y" type="number" value="0" class="text--c0 width--fit"/>
        </div>
    </div>
    <div class="columns width--fit">
        <div class="column-1-2">
            <label class="display-x">0</label>
        </div>
        <div class="column-1-2">
            <label class="display-y">0</label>
        </div>
    </div>
</div>

<!-- message -->
<div class="message-container on-top-left css-trans"></div>
<div class="warning-message hidden css-trans rounded--x10 margin--x10 padding--x10 background--c3 text--cred background--cyellow">
    <h1 class="symbol sym-warning"> message-title</h1>
    <p class="text--c0">message-text</p>
</div>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve"
     viewBox="0 0 12 12"
     class="circle-progress float-right hidden"
     style="width:20px;transform:rotate(-90deg);"
     fill="transparent"
     stroke="gray">
    <circle cx="6" cy="6" r="5"
            stroke-linecap="round"
            stroke-opacity="1"
            stroke-width="2"
            stroke-dashoffset="0"
            stroke-dasharray="31.415926535897932384626433832795"/>
</svg>

<!-- JS -->
<script type="text/javascript" src="http://localhost/jquery/1.11/jquery.js"></script>
<script type="text/javascript" src="../dist/jquery.panel.suite.min.js"></script>
<script type="text/javascript" src="../src/jquery.theme.js?version=1"></script>
<script>
    Appanel({
        clock: {
            useSweep: false,
            speed: 1,

            name: 'analogue-clock',
            state: 'initialized',

            setUseSweep: function (useSweep) {
                if (useSweep == null) useSweep = false;
                var changed = this.useSweep !== useSweep;
                this.useSweep = useSweep;

                if (changed && this.state === 'started') {
                    Appanel.set(this.name + ':analogue', useSweep);
                    if (!useSweep)
                        Appanel.util.refresh();
                    else
                        this.start(new Date(), this.speed);
                }
            },

            setSecond: function (second) {
                this.percentSecond = second / 60;
                if (!this.useSweep) {
                    if (this.state === 'starting' && second >= 59) {
                        /*console.debug('setSecond: in case starting at 59');*/
                        this.$second.css('transform', 'rotate(-6deg)');
                    } else if (second === 59) {
                        /*console.debug('setSecond: in case of 59');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                        this.setTimeout(function () {
                            Appanel.clock.$second.removeClass('css-trans');
                            Appanel.clock.$second.css('transform', 'rotate(-6deg)');
                            Appanel.clock.setTimeout(function () {
                                Appanel.clock.$second.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setSecond: in another case');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                    }
                }
                this.second = second;
            },

            setMinute: function (minute) {
                if (this.useSweep) {
                    this.percentMinute = (minute + this.percentSecond) / 60;
                } else {
                    this.percentMinute = minute / 60;
                    this.minuteDegree = (this.percentMinute * 360);
                    if (this.state === 'starting' && minute >= 59) {
                        /*console.debug('setMinute: in case starting at 59');*/
                        Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                    } else if (minute === 59) {
                        /*console.debug('setMinute: in case of 59');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                        this.setTimeout(function () {
                            Appanel.clock.$minute.removeClass('css-trans');
                            Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                            Appanel.clock.setTimeout(function () {
                                Appanel.clock.$minute.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setMinute: in another case');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                    }

                    // update hour hand at every minute
                    if (this.hour !== undefined) this.setHour(this.hour);
                }
                this.minute = minute;
            },

            setHour: function (hour) {
                if (!this.useSweep) {
                    this.hourDegree = ((hour + this.percentMinute) / 12) * 360;
                    if (hour === 11) {
                        if (this.hour !== hour) {
                            /*console.debug('setHour: in case of 11');*/
                            this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                            this.setTimeout(function () {
                                Appanel.clock.$hour.removeClass('css-trans');
                                Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                                Appanel.clock.setTimeout(function () {
                                    Appanel.clock.$hour.addClass('css-trans');
                                }, 100);
                            }, 100);
                        } else {
                            /*console.debug('setHour: in case after 11');*/
                            Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                        }
                    } else {
                        /*console.debug('setHour: in another case');*/
                        this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                    }
                }
                this.hour = hour;
            },

            refreshTime: function () {
                this.ticker[0].innerText = this.hour + ':' + this.minute + ':' + this.second;
            },

            secondTick: function () {
                var second = this.second + 1;
                if (second >= 60)
                    this.minuteTick();
                else
                    this.setSecond(second);
            },

            minuteTick: function () {
                this.setSecond(0);

                var minute = this.minute + 1;
                if (minute === 60)
                    this.hourTick();
                else
                    this.setMinute(minute);
            },

            hourTick: function () {
                this.setMinute(0);

                var hour = this.hour + 1;
                if (hour === 24)
                    this.setHour(0);
                else
                    this.setHour(hour);
            },

            addProperty: function (theme, name, prop, target) {
                $(theme.add(name, prop, target)).on('css-property:error', function (ev, data) {
                    Appanel.util.warn('Invalid Color', `css-property '${data.property}' not supports the value '${data.value}'`);
                });
            },

            initProfile: function () {
                var theme = new Theme();
                this.addProperty(theme, 'handSecond', ['stroke', 'fill'], $('.second svg'));
                this.addProperty(theme, 'handMinute', ['stroke', 'fill'], $('.minute svg'));
                this.addProperty(theme, 'handHour', ['stroke', 'fill'], $('.hour svg'));
                this.addProperty(theme, 'numbers', ['stroke', 'fill'], $('.numbers text'));
                this.addProperty(theme, 'minutes', ['stroke', 'fill'], $('.one.minutes line'));
                this.addProperty(theme, 'fiveMinutes', ['stroke', 'fill'], $('.five.minutes line'));
                this.addProperty(theme, 'frame', 'stroke', $('.numbers circle'));
                this.addProperty(theme, 'background', 'fill', $('.numbers circle'));
                this.addProperty(theme, 'outSide', 'background-color', $('.out-side'));

                theme.add('chandSecond', 'background-color', $('.color-handSecond'), 'handSecond');
                theme.add('chandMinute', 'background-color', $('.color-handMinute'), 'handMinute');
                theme.add('chandHour', 'background-color', $('.color-handHour'), 'handHour');
                theme.add('cnumbers', 'background-color', $('.color-numbers'), 'numbers');
                theme.add('cminutes', 'background-color', $('.color-minutes'), 'minutes');
                theme.add('cfiveMinutes', 'background-color', $('.color-fiveMinutes'), 'fiveMinutes');
                theme.add('cframe', 'background-color', $('.color-frame'), 'frame');
                theme.add('cbackground', 'background-color', $('.color-background'), 'background');
                theme.add('coutSide', 'background-color', $('.color-outSide'), 'outSide');

                this.handle(new Profile(this.name, theme, {useSweep: false}));
            },

            handle: function (profile) {
                Appanel['profile'] = profile;

                if (!profile.contains('default')) {
                    profile.save('default', {
                        theme: {
                            handSecond: 'red',
                            handMinute: 'orange',
                            handHour: 'gold',
                            numbers: 'gold',
                            minutes: '#000000',
                            fiveMinutes: '#222222',
                            frame: 'silver',
                            background: 'navy',
                            outSide: 'bluesky'
                        },
                        more: {useSweep: this.useSweep, clock: 'original'}
                    });
                }

                var e = $('.theme .profile'),
                    container = e.parents('.profile-container'),
                    template = container[0].innerHTML,
                    clockContainer = $('.clock-container'),
                    clockTemplate = clockContainer[0].innerHTML,
                    bgContainer = $('.background-container'),
                    bgTemplate = bgContainer[0].innerHTML,
                    comContainer = $('.combination-container'),
                    comTemplate = comContainer[0].innerHTML,
                    count = profile.ids.length,
                    theme = profile.theme,
                    themeProperty;

                // handle movement buttons
                Appanel.map([
                    ['.analogue-move', 'click', function () {
                        Appanel.clock.setUseSweep(false);
                    }],
                    ['.smooth-move', 'click', function () {
                        Appanel.clock.setUseSweep(true);
                    }]
                ]);

                // handle combination buttons
                comContainer[0].innerHTML = "";
                for (var i = 0; i < this.combinations.length; i++) {
                    comContainer.append(comTemplate.replace('combination-name', this.combinations[i].display));
                    button = comContainer.find('.combination-item').removeClass('combination-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadCombination(ev.data.index);
                        }, {name: this.combinations[i].name, index: i}]
                    ]);
                }

                // handle bakground buttons
                bgContainer[0].innerHTML = "";
                for (var i = 0; i < this.backgrounds.length; i++) {
                    bgContainer.append(bgTemplate.replace('background-name', this.backgrounds[i].display));
                    button = bgContainer.find('.background-item').removeClass('background-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.rotateBackground('stop');
                            Appanel.clock.loadBackground(ev.data.index);
                        }, {name: this.backgrounds[i].name, index: i}]
                    ]);
                }

                // handle Auto Change Background button
                Appanel.map([[$('.auto-change-background'), 'click', function (ev) {
                    Appanel.util.input('Time Interval', 'Enter duration before every change of background (in seconds):', '15',
                        function (data, seconds) {
                            if (!$.isNumeric(seconds)) {
                                Appanel.util.warn("Invalid Value", "Time interval need number value like 12345, entered value '" + seconds + "' is not a number!", 10);
                                return;
                            }
                            Appanel.clock.rotateBackground(seconds * 1000);
                        });
                }]]);

                // handle clock buttons
                clockContainer[0].innerHTML = "";
                for (var i = 0; i < this.clocks.length; i++) {
                    clockContainer.append(clockTemplate.replace('clock-name', this.clocks[i].display));
                    button = clockContainer.find('.clock-item').removeClass('clock-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadClock(ev.data.index, function () {
                                this.updateElements();
                                Appanel.profile.theme.updateElements();
                                this.ready();
                                /*Appanel.profile.load(Appanel.profile.current);
                                this.loadBackground(this.backgroundIndex(this.background));
                                $('.clock').css('display', 'block');*/
                                /*Appanel.util.refresh();*/
                            });
                        }, {name: this.clocks[i].name, index: i}]
                    ]);
                    if (this.clocks[i].name === profile.more.clock) button.click();
                }

                // handle profile buttons
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    container.append(template.replace('profile-name', profile.ids[i]));
                    button = container.find('.profile').removeClass('profile');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            var profile = Appanel.profile.load(ev.data.profile),
                                profileName = $('.profile-name');
                            profileName[0].innerText = ev.data.profile;
                            profileName[0].title = 'Current Theme : ' + ev.data.profile;
                        }, {theme: profile.theme, profile: profile.ids[i]}]
                    ]);
                    if (profile.ids[i] === profile.current) button.click();
                }

                // handle add profile button
                Appanel.map([[$('.theme .add-profile'), 'click', function (ev) {
                    Appanel.util.input('New Profile', 'Enter profile name:', 'default',
                        function (data, name) {
                            if (Appanel.profile.contains(name)) {
                                alert('Profile ' + name + ' already exists!');
                            } else {
                                Appanel.profile.save(name);
                                Appanel.util.refresh();
                            }
                        });
                }]]);

                // handle profile name button
                button = $('.theme .profile-name');
                Appanel.map([[button, 'click', function (ev) {
                    var oldName = ev.currentTarget.innerText;
                    Appanel.util.input('Change Theme Name', 'Enter new name:', oldName,
                        function (data, newName) {
                            if (Appanel.profile.contains(newName)) {
                                alert('Profile ' + newName + ' already exists!');
                            } else {
                                Appanel.profile.save(newName);
                                Appanel.profile.remove(data.oldName);
                                Appanel.profile.setCurrent(newName);
                                Appanel.util.refresh();
                            }
                        }, {oldName: oldName});
                }]]);

                // handle color buttons
                var colorPanel = $('.theme .colors'),
                    title, button;
                for (var i in theme) {
                    themeProperty = theme[i];
                    if (i.startsWith('jQuery') || $.isArray(themeProperty) || themeProperty.constructor === Function || themeProperty.sourceProperty != null) continue;
                    button = colorPanel.find('.color-' + i);
                    title = button[0].innerText;
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.util.input(ev.data.title, 'Enter color value:', ev.data.property.get(),
                                function (data, color) {
                                    data.property.set(color);
                                    Appanel.profile.save($('.profile-name')[0].innerText);
                                }, {property: ev.data.property});
                        }, {title: title, property: themeProperty}]
                    ]);
                }
            },

            setTimeout: function (func, millisec) {
                this.clearTimeout();
                this.timeout = window.setTimeout(func, millisec);
            },

            clearTimeout: function () {
                if (this.timeout !== undefined) {
                    clearTimeout(this.timeout);
                    delete this.timeout;
                }
            },

            setInterval: function (func, millisec) {
                this.clearInterval();
                this.interval = window.setInterval(func, millisec);
            },

            clearInterval: function () {
                if (this.interval !== undefined) {
                    clearInterval(this.interval);
                    delete this.interval;
                }
            },

            updateElements: function () {
                this.$second = $(this.$second.selector);
                this.$minute = $(this.$minute.selector);
                this.$hour = $(this.$hour.selector);
                this.sweeper = $(this.sweeper.selector);
            },

            start: function (now, speed) {
                var hour = now.getHours(),
                    minute = now.getMinutes(),
                    second = now.getSeconds(),
                    clock = Appanel.clock,
                    useSweep = clock.useSweep;

                clock.state = 'starting';

                if (speed === undefined) speed = 1;
                clock.speed = speed;
                console.info("clock start at ", hour, ":", minute, ":", second, ' ', speed, 'X speed');

                clock.ticker = $('.ticker');
                clock.$second = $('.second');
                clock.$minute = $('.minute');
                clock.$hour = $('.hour');
                clock.sweeper = $('.hour,.minute,.second').addClass('hidden');

                if (clock.useSweep) {
                    var options = {
                        duration: 0.00001,
                        on: "sweep:ready",
                        sweep: []
                    };

                    //1round = 12hours = 60s x 60 x 12 (loop=1day=2rounds)
                    options.sweep.push(this.getSweeper('.hour > svg', 'ani-clock', 43200, 2));

                    //1round = 60minutes = 60s x 60 (loop=1day=12rounds)
                    options.sweep.push(this.getSweeper('.minute > svg', 'ani-clock', 3600, 12));

                    //1round = 1minutes = 60s (loop=1day=43200rounds)
                    options.sweep.push(this.getSweeper('.second > svg', 'ani-clock', 60, 3600));

                    clock.sweep = options;
                }

                // force move clock hands
                Appanel.clock.useSweep = false;
                clock.setSecond(second + 1);
                clock.setMinute(minute);
                clock.setHour(hour);
                Appanel.clock.useSweep = useSweep;

                // reset all animations
                if (clock.sweeper[0].sweepID) {
                    clock.sweeper
                        .sweep('pause')
                        .each(function (i, e) {
                            delete e.sweepID;
                            delete e.sweepContext;
                        })
                        .find('svg')
                        .each(function (i, e) {
                            delete e.sweepID;
                            delete e.sweepContext;
                        })
                        .removeClass('ani-clock')
                        .css('transform', 'rotate(0deg)')
                        .css('animation-duration', '')
                        .css('animation-iteration-count', '')
                        .css('animation-timing-function', '')
                    ;
                }

                // delay start
                Appanel.clock.setTimeout(function () {
                    var clock = Appanel.clock;

                    if (clock.useSweep) {
                        clock.sweeper.sweep(clock.sweep).sweep('speedx', clock.speed);
                    } else {
                        clock.sweeper.addClass('css-trans');
                    }

                    clock.setInterval(function () {
                        Appanel.clock.sweeper.removeClass('hidden');
                        Appanel.clock.secondTick();
                        Appanel.clock.refreshTime();
                    }, 1000 * (1 / clock.speed));

                }, 1000 - now.getMilliseconds());

                clock.state = 'started';
            },

            getSweeper: function (selector, play, duration, loop) {
                return {
                    selector: selector,
                    play: play,
                    timing: 'linear',
                    duration: duration,
                    loop: loop
                };
            },

            clocks: [],

            clockIndex: function (name) {
                var clocks = this.clocks;
                for (var i = 0; i < clocks.length; i++) {
                    if (clocks[i].name === name) return i;
                }
                return 0;
            },

            loadClock: function (clockIndex, callback) {
                var clock = this.clocks[clockIndex],
                    requestDate = (new Date()).toLocaleTimeString(),
                    clockName = clock.name,
                    url = Appanel.util.myURL() + '-' + clockName + '.html?v=' + requestDate;

                this.clock = clockName;
                Appanel.set(this.name + ':clock', clockName);

                // test: get clock from first element
                console.info("Clock URL: ", url);
                $.get(url).complete(function (result, status) {
                    var clockHtml = result.responseText,
                        headStart = clockHtml.indexOf('<head>'),
                        headEnd = clockHtml.indexOf('</head>') + 7;

                    console.info('load clock completed at ', new Date().toLocaleTimeString());
                    clockHtml = clockHtml.substring(0, headStart) + clockHtml.substring(headEnd + 1);
                    $('.cover').html(clockHtml);

                    if (callback !== undefined) {
                        Appanel.clock.setTimeout(function () {
                            callback.call(Appanel.clock);
                        }, 100);
                    }
                });
            },

            backgrounds: [],

            backgroundIndex: function (name) {
                var backgrounds = this.backgrounds;
                for (var i = 0; i < backgrounds.length; i++) {
                    if (backgrounds[i].name === name) return i;
                }
                return 0;
            },

            loadBackground: function (backgroundIndex) {
                var bgName = this.backgrounds[backgroundIndex].name;

                this.background = bgName;
                Appanel.set(this.name + ':background', bgName);

                /*TODO: preload background-image before switch to it*/
                this.setAttributes(this.backgrounds[backgroundIndex]);
            },

            rotateBackgroundInterval: null,

            rotateBackground: function (secondsOrStop, startFrom) {
                if (startFrom !== undefined) {
                    this.loadBackground(startFrom);
                }

                if (secondsOrStop !== undefined) {
                    if (this.rotateBackgroundInterval != null) clearInterval(this.rotateBackgroundInterval);
                    if (secondsOrStop === 'stop') return;
                    this.rotateBackgroundInterval = setInterval(function () {
                        Appanel.clock.rotateBackground.call(Appanel.clock);
                    }, secondsOrStop);
                    return;
                }

                var bgIndex = (startFrom === undefined ? this.backgroundIndex(this.background) : startFrom) + 1;
                if (bgIndex >= this.backgrounds.length) bgIndex = 0;
                if (startFrom === undefined) this.loadBackground(bgIndex);
            },

            /**
             * Set Background Attributes.
             *
             * Example:
             * Appanel.clock.setAttributes({
             *      image: 'img/swiss-railway-clock-scaled.webp',
             *      imageWidth: 2560,
             *      imageHeight: 1707,
             *      imageFilter: 0.25,
             *
             *      clockYInPercent: 0.311,
             *      clockWInPercent: 0.25,
             *
             *      clockXInPercent: 0.5715,
             *      clockHInPercent: 0.37
             * });
             */
            setAttributes: function (attributes) {
                this.bgImageAttributes = Object.assign(attributes, {
                    body: $('body')
                        .removeClass('css-trans')
                        .css('background-image', 'url(' + attributes.image + ')')
                        .css('background-repeat', 'no-repeat'),
                    cover: $('.cover'),
                    clock: $('.clock')
                });

                $('.out-side').css('opacity', (100 * this.bgImageAttributes.imageFilter) + '%');

                var resize = function (ev) {
                    var a = Appanel.clock.bgImageAttributes;

                    a.screenW = parseInt(a.body.css('width'));
                    a.screenH = parseInt(a.body.css('height'));

                    a.ratioW = a.screenW / a.imageWidth;
                    a.ratioH = a.screenH / a.imageHeight;

                    if (a.ratioW >= a.ratioH) {
                        a.imageX = 0;
                        a.imageY = (a.screenH - (a.ratioW * a.imageHeight)) / 2;
                        a.imageSize = a.screenW;
                        a.coverX = a.clockXInPercent * a.screenW;
                        a.coverY = a.imageY + (a.ratioW * a.imageHeight * a.clockYInPercent);
                        a.coverSize = (100 * a.clockWInPercent) + 'vw';
                    } else {
                        a.imageX = (a.screenW - (a.ratioH * a.imageWidth)) / 2;
                        a.imageY = 0;
                        a.imageSize = a.imageWidth * a.ratioH;
                        a.coverX = a.imageX + (a.ratioH * a.imageWidth * a.clockXInPercent);
                        a.coverY = a.clockYInPercent * a.screenH;
                        a.coverSize = (100 * a.clockHInPercent) + 'vh';
                    }

                    a.body
                        .css('background-position-x', a.imageX + 'px')
                        .css('background-position-y', a.imageY + 'px')
                        .css('background-size', a.imageSize + 'px');

                    a.cover
                        .css('top', a.coverY + 'px')
                        .css('left', a.coverX + 'px');

                    a.clock
                        .css('width', a.coverSize)
                        .css('height', a.coverSize);
                };

                $(window).on('resize', resize);
                resize();
            },

            combinations: [],

            combinationIndex: function (name) {
                var combinations = this.combinations;
                for (var i = 0; i < combinations.length; i++) {
                    if (combinations[i].name === name) return i;
                }
                return 0;
            },

            loadCombination: function (combinationIndex) {
                var combination = this.combinations[combinationIndex];
                Appanel.util.disableRefresh = true;

                this.loadClock(this.clockIndex(combination.clock), function () {
                    console.debug('passed: load clock');

                    this.updateElements();
                    Appanel.profile.theme.updateElements();
                    console.debug('passed: update elements');

                    this.start(new Date());

                    this.loadBackground(this.backgroundIndex(combination.background));
                    $('.clock').css('display', 'block');
                    console.debug('passed: load background');

                    Appanel.profile.load(combination.theme);
                    console.debug('passed: load theme');

                    this.setUseSweep(!combination.analogue);
                    console.debug('passed: analogue switch');

                    Appanel.util.disableRefresh = false;
                });
            },

            addCombination: function () {
                /*TODO: save and push to arrays*/
            },

            loadJSON: function (name, callback) {
                var requestDate = (new Date()).toLocaleTimeString(),
                    myJson = Appanel.util.myURL() + '-' + name + '.json?v=' + requestDate;

                console.info("JSON URL: ", myJson);
                $.getJSON(myJson).complete(function (json, status) {
                    console.info('load ', name, 'completed at ', new Date().toLocaleTimeString());
                    Appanel.clock[name] = json.responseJSON;
                    if ($.isFunction(callback)) callback.call(Appanel.clock, json, status);
                });
            },

            load: function () {
                this.setUseSweep(Appanel.get(this.name + ':analogue'));
                this.loadJSON('clocks', function () {
                    if (status === 'parsererror') {
                        this.clocks = [];
                        Appanel.util.warn('IMPORTANT', 'load clock list failed the "' + Appanel.util.myURL() + '-clocks.json" may be corrupted', 20);
                        return;
                    }
                    this.loadClock(this.clockIndex(Appanel.get(this.name + ':clock')), Appanel.clock.ready);
                });
                this.loadJSON('backgrounds', function (json, status) {
                    if (status === 'parsererror') {
                        this.backgrounds = [];
                        Appanel.util.warn('IMPORTANT', 'load background list failed the "' + Appanel.util.myURL() + '-backgrounds.json" may be corrupted', 20);
                    }
                });
                this.loadJSON('combinations', function (json, status) {
                    if (status === 'parsererror') {
                        this.backgrounds = [];
                        Appanel.util.warn('IMPORTANT', 'load combination list failed the "' + Appanel.util.myURL() + '-combinations.json" may be corrupted', 20);
                    }
                });
            },

            activated: function () {
                Appanel.clock.start(new Date());
            },

            ready: function () {
                var firstTime = this.state === 'initialized';
                this.start(new Date());
                /*this.start(new Date(2022, 12, 25, 17, 59, 59), 1);*/

                // need to show after started
                this.loadBackground(this.backgroundIndex(Appanel.get(this.name + ':background')));
                $('.clock').css('display', 'block');

                if (firstTime) {
                    this.initProfile();
                    $(window).on('focus', this.activated);
                } else {
                    Appanel.profile.load(Appanel.profile.current);
                }
            }

        },

        util: {
            disableRefresh: false,

            input: function (title, label, defaultValue, handler, data) {
                if (data === undefined) data = {};

                var inputPanel = $('.input-panel');
                inputPanel.find('label')[0].innerText = label;
                inputPanel.find('input')[0].defaultValue = defaultValue;

                // show dialog with max-number-input
                var dialogue = Appanel.selection('information', title, inputPanel[0].innerHTML, {
                    buttons: ['OK', 'Cancel']
                });

                Appanel.map([
                    [dialogue, 'selection:open', function (ev, button) {
                        var $input = $(ev.target).find('input');
                        $input[0].select();
                        $input.focus();
                    }],
                    [dialogue, 'selection:closed', function (ev, button) {
                        if (button.button === 'OK') {
                            var number = $(ev.target).find('input')[0].value;
                            handler(ev.data, isNaN(number) ? number : Math.abs(number));
                        }
                    }, data]
                ]);
            },

            seeNMove: function (selector, propertyX, propertyY) {
                var inputPanel = $('.seenmove-panel'),
                    target = $(selector),
                    x = target.css(propertyX),
                    y = target.css(propertyY);

                inputPanel.find('.label-x').text(propertyX);
                inputPanel.find('.label-y').text(propertyY);

                // show dialog with max-number-input
                var dialogue = Appanel.selection('information', 'See n Move', inputPanel[0].innerHTML, {buttons: ['Close']});

                Appanel.map([
                    [dialogue, 'selection:open', function (ev) {
                        var panel = $(ev.target),
                            inputX = panel.find('.input-x'),
                            inputY = panel.find('.input-y'),
                            displayX = panel.find('.display-x'),
                            displayY = panel.find('.display-y'),
                            data = ev.data;

                        /*on keyup then set property*/
                        Appanel.map([
                            [inputX, 'keyup', function (ev) {
                                var value = ev.currentTarget.value;
                                ev.data.target.attr(ev.data.property, value);
                                ev.data.display.text(ev.data.target.attr(ev.data.property));
                            }, {target: ev.data.target, property: propertyX, display: displayX}],
                            [inputY, 'keyup', function (ev) {
                                var value = ev.currentTarget.value;
                                ev.data.target.attr(ev.data.property, value);
                                ev.data.display.text(ev.data.target.attr(ev.data.property));
                            }, {target: ev.data.target, property: propertyY, display: displayY}]
                        ]);

                        inputX[0].value = data.target.attr(data.propertyX);
                        inputY[0].value = data.target.attr(data.propertyY);

                        displayX.text(inputX[0].value);
                        displayY.text(inputY[0].value);

                        inputX[0].select();
                        inputX.focus();
                    }, {target: target, propertyX: propertyX, propertyY: propertyY}]
                ]);
            },

            refresh: function () {
                if (this.disableRefresh) return;
                var src = window.top.location.href,
                    lastIndex = src.indexOf("?");
                src = src.substr(0, lastIndex > 0 ? lastIndex : src.length) + '?refresh=' + (new Date()).toLocaleTimeString();
                window.top.location.href = src;
            },

            refreshAfter: function (seconds) {
                var timeout = setTimeout(function () {
                    clearTimeout(timeout);
                    Appanel.util.refresh();
                }, seconds * 1000);
            },

            removeAfter: function (seconds, $e) {
                $e.append($('.circle-progress')[0].outerHTML.replace('hidden', ''));
                var timeout = setTimeout(function () {
                    clearTimeout(timeout);
                    $e.remove();
                }, seconds * 1000);
                Appanel.chains($e.find('.circle-progress > circle'), 'ani-hide-circle-progress:' + seconds);
            },

            warn: function (title, text, seconds) {
                var $container = $('.message-container'),
                    $message;

                $container.append(
                    $('.warning-message')[0].outerHTML
                        .replace('message-title', title)
                        .replace('message-text', text)
                );

                $message = $container.find('.warning-message')
                    .removeClass('warning-message')
                    .removeClass('hidden');

                this.removeAfter(seconds === undefined ? 6 : seconds, $message);
            },

            myURL: function () {
                var location = window.location;
                src = location.origin + location.pathname;
                src.indexOf('clock-1.html');
                return src.replace('.html', '');
            },

            createMinutes: function (container, degrees, count) {
                var template = container[0].innerHTML;
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    if (degrees[i] === 0) continue;
                    container.append(template.replace('number-id', 'number-' + i));
                    container.find('.number-' + i).css('transform', 'rotate(' + degrees[i] + 'deg)');
                }
            }
        },

        ready: function () {
            Appanel.clock.load();
            Appanel.util.refreshAfter(3600);
        }
    });
</script>

</body>
</html>
