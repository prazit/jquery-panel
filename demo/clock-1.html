<!DOCTYPE html>
<html>

<head>
    <title>Analog Clock using focus-3.html</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="focus-3.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/sym-fa.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/ani-anicss.css"/>
    <style>
        @keyframes ani-clock-reset {
            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes ani-clock {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .ani-clock {
            -webkit-animation-name: ani-clock;
            animation-name: ani-clock;
        }

        .ani-clock-reset {
            -webkit-animation-name: ani-clock-reset;
            animation-name: ani-clock-reset;
        }

        @keyframes ani-hide-circle-progress {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -31.415926535897932384626433832795;
            }
        }

        .ani-hide-circle-progress {
            -webkit-animation-name: ani-hide-circle-progress;
            animation-name: ani-hide-circle-progress;
            animation-timing-function: linear;
        }

        .cover {
            position: absolute;
            width: 100vh;
            height: 100vh;
            left: calc((100vw - 100vh) / 2);
        }

        .clock {
            position: absolute;
            width: 100vh;
            height: 100vh;
            display: none;
        }

        .clock-ui:hover .board {
            width: 70vw;
        }

        .css-trans {
            transition-duration: 0.2s;
        }

        .css-trans--x2 {
            transition-duration: 0.4s;
        }
    </style>
</head>

<body class="css-trans fixed background--c0 fit-width fit-height" style="font-family: Arial,sans-serif;">

<!-- background -->
<div class="background-image fit-height fit-width layer-1">
</div>

<!-- filter -->
<div class="out-side on-top-left fit-width fit-height layer-2">
    <h1 class="on-top footprint padding--x10 opacity--x0 opacity--x100--at">Analogue Clock v1</h1>
</div>

<!-- clock -->
<div class="cover layer-3">
    <div class="clock wrapper rounded--x20">
        <div class="clock background">
            <!-- store the copied of clock background to make it always hide the background-image under the clock -->
        </div>
        <div class="clock foreground">
            <!-- this content will be replaced by clock -->
        </div>
    </div>
</div>

<!-- UI Area -->
<div class="clock-ui on-left css-trans--x2 width--x100 opacity--x0 opacity--x100--at layer-4" style="height:70vh;">
    <div class="board css-trans fit-height width--x1 right-rounded--x20 bottom-rounded--x20 top-border--x10 right-border--x10 bottom-border--x10 on-left" style="border-color:rgba(255,255,255,0.5);">
        <div class="fit-width fit-height scrollable" style="background-color:rgba(0,0,0,0.8)">

            <!-- animation selector -->
            <div class="inline-column css-trans margin--x20" style="display: inline-block">
                <div class="rounded--x50 center-text">
                    <span class="analogue-move button left-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at">Analogue Move</span>
                    <span class="smooth-move button right-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at">Smooth Move</span>
                </div>
            </div>
            <br/>

            <!-- clocks & backgrounds -->
            <div class="inline-column css-trans">
                <!-- backgrounds -->
                <div class="pull-left backgrounds margin--x10 rounded--x20 border--x4 border--c3">
                    <span class="background-list top-child background--c3 opacity--x70 padding--x10 center-text">Backgrounds</span>
                    <div class="ui scrollable background-container">
                        <span class="background-item button child background--c1 background--c0--at padding--x10 left-text">background-name</span>
                    </div>
                    <span class="auto-change-background bottom-child button background--c3 background--c0--at opacity--x70 padding--x10 center-text">Auto Change</span>
                </div>

                <!-- clocks -->
                <div class="pull-right clocks margin--x10 rounded--x20 border--x4 border--c3">
                    <span class="clock-list top-child background--c3 opacity--x70 padding--x10 center-text">Clocks</span>
                    <div class="ui scrollable clock-container">
                        <span class="clock-item button child background--c1 background--c0--at padding--x10 left-text">clock-name</span>
                    </div>
                    <span class="bottom-child background--c3 opacity--x70 padding--x10"></span>
                </div>
            </div>

            <!-- colors -->
            <div class="inline-column css-trans theme margin--x10">
                <div class="pull-left colors rounded--x20 border--x4 border--c3 margin--x10">
                    <span class="profile-name button top-child background--c3 background--c0--at opacity--x70 padding--x10 center-text">Profile</span>
                    <div class="ui scrollable">
                        <span class="color-handSecond button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Second Hand</span>
                        <span class="color-handMinute button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minute Hand</span>
                        <span class="color-handHour button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Hour Hand</span>
                        <span class="color-numbers button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Numbers</span>
                        <span class="color-timer button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Timer</span>
                        <span class="color-minutes button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minutes</span>
                        <span class="color-fiveMinutes button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Five Minutes</span>
                        <span class="color-frame button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Frame</span>
                        <span class="color-background button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Background</span>
                        <span class="color-outSide button child background--c1 background--c0--at padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Outside</span>
                    </div>
                    <span class="bottom-child background--c3 opacity--x70 padding--x10"></span>
                </div>
                <div class="pull-right rounded--x20 border--x4 border--c3 margin--x10">
                    <span class="profile-list top-child background--c3 opacity--x70 padding--x10 center-text">Themes</span>
                    <div class="ui scrollable profile-container">
                        <span class="profile button child background--c1 background--c0--at padding--x10 left-text">profile-name</span>
                    </div>
                    <span class="add-profile button bottom-child background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
                </div>
            </div>

            <!-- combination -->
            <div class="inline-column combinations css-trans margin--x10 rounded--x20 border--x4 border--c3">
                <span class="combination-list top-child background--c3 opacity--x70 padding--x10 center-text">Presets</span>
                <div class="ui scrollable combination-container">
                    <span class="combination-item button child background--c1 background--c0--at padding--x10 left-text">combination-name</span>
                </div>
                <span class="add-combination bottom-child button background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script type="text/javascript" src="http://localhost/jquery/1.11/jquery.js"></script>
<script type="text/javascript" src="../dist/jquery.panel.suite.min.js"></script>
<script type="text/javascript" src="../src/jquery.theme.js?version=1"></script>
<script type="text/javascript" src="demo-util.js?refresh=1"></script>
<script>
    Appanel({
        clock: {
            options: {
                useSweep: false,
                speed: 1
            },

            name: 'analogue-clock',
            state: 'initialized',

            defaults: {
                clocks: [],
                backgrounds: [],
                combinations: [],
                control: {
                    clocks: 0,
                    backgrounds: 0,
                    combainations: 0
                }
            },

            loadOptions: function () {
                var options = Appanel.get(this.name + ':options');
                if (options != null) {
                    this.options = options;
                }
            },

            saveOptions: function () {
                Appanel.set(this.name + ':options', this.options);
            },

            setUseSweep: function (useSweep) {
                if (useSweep == null) useSweep = false;
                var changed = this.options.useSweep !== useSweep;
                this.options.useSweep = useSweep;

                var active,inactive;
                if (useSweep) {
                    inactive = '.analogue-move';
                    active = '.smooth-move';
                }else{
                    active = '.analogue-move';
                    inactive = '.smooth-move';
                }
                $(active).css('background-color','yellow');
                $(inactive).css('background-color','silver');

                if (changed && this.state === 'started') {
                    this.saveOptions();
                    this.start(new Date(), this.options.speed);
                }
            },

            setSecond: function (second) {
                this.percentSecond = second / 60;
                if (!this.options.useSweep) {
                    if (this.state === 'starting' && second >= 59) {
                        /*console.debug('setSecond: in case starting at 59');*/
                        this.$second.css('transform', 'rotate(-6deg)');
                    } else if (second === 59) {
                        /*console.debug('setSecond: in case of 59');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                        this.setTimeout(function () {
                            Appanel.clock.$second.removeClass('css-trans');
                            Appanel.clock.$second.css('transform', 'rotate(-6deg)');
                            Appanel.clock.setTimeout(function () {
                                Appanel.clock.$second.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setSecond: in another case');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                    }
                }
                this.second = second;
            },

            setMinute: function (minute) {
                if (this.options.useSweep) {
                    this.percentMinute = (minute + this.percentSecond) / 60;
                } else {
                    this.percentMinute = minute / 60;
                    this.minuteDegree = (this.percentMinute * 360);
                    if (this.state === 'starting' && minute >= 59) {
                        /*console.debug('setMinute: in case starting at 59');*/
                        Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                    } else if (minute === 59) {
                        /*console.debug('setMinute: in case of 59');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                        this.setTimeout(function () {
                            Appanel.clock.$minute.removeClass('css-trans');
                            Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                            Appanel.clock.setTimeout(function () {
                                Appanel.clock.$minute.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setMinute: in another case');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                    }

                    // update hour hand at every minute
                    if (this.hour !== undefined) this.setHour(this.hour);
                }
                this.minute = minute;
            },

            setHour: function (hour) {
                if (!this.options.useSweep) {
                    this.hourDegree = ((hour + this.percentMinute) / 12) * 360;
                    if (hour === 11) {
                        if (this.hour !== hour) {
                            /*console.debug('setHour: in case of 11');*/
                            this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                            this.setTimeout(function () {
                                Appanel.clock.$hour.removeClass('css-trans');
                                Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                                Appanel.clock.setTimeout(function () {
                                    Appanel.clock.$hour.addClass('css-trans');
                                }, 100);
                            }, 100);
                        } else {
                            /*console.debug('setHour: in case after 11');*/
                            Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                        }
                    } else {
                        /*console.debug('setHour: in another case');*/
                        this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                    }
                }
                this.hour = hour;
            },

            twoDigit: function (number) {
                if (number < 10) return '0' + number;
                return ('' + number).substring(0, 2);
            },

            refreshTime: function () {
                this.ticker.text(this.twoDigit(this.hour) + ':' + this.twoDigit(this.minute) + ':' + this.twoDigit(this.second));
            },

            secondTick: function () {
                var second = this.second + 1;
                if (second >= 60)
                    this.minuteTick();
                else
                    this.setSecond(second);
            },

            minuteTick: function () {
                this.setSecond(0);

                var minute = this.minute + 1;
                if (minute === 60)
                    this.hourTick();
                else
                    this.setMinute(minute);
            },

            hourTick: function () {
                this.setMinute(0);

                var hour = this.hour + 1;
                if (hour === 24)
                    this.setHour(0);
                else
                    this.setHour(hour);
            },

            addProperty: function (theme, name, prop, target) {
                $(theme.add(name, prop, target)).on('css-property:error', function (ev, data) {
                    var title = 'Invalid Color',
                        message = `css-property '${data.property}' not supports the value '${data.value}'`;
                    console.warn(title + ': ', message);
                    Appanel.util.warn(title, message);
                });
            },

            initProfile: function () {
                var theme = new Theme();
                this.addProperty(theme, 'handSecond', ['stroke', 'fill'], $('.second svg'));
                this.addProperty(theme, 'handMinute', ['stroke', 'fill'], $('.minute svg'));
                this.addProperty(theme, 'handHour', ['stroke', 'fill'], $('.hour svg'));
                this.addProperty(theme, 'numbers', ['stroke', 'fill'], $('.numbers svg'));
                this.addProperty(theme, 'timer', ['stroke', 'fill'], $('.ticker'));
                this.addProperty(theme, 'minutes', ['stroke', 'fill'], $('.one.minutes svg'));
                this.addProperty(theme, 'fiveMinutes', ['stroke', 'fill'], $('.five.minutes svg'));
                this.addProperty(theme, 'frame', 'stroke', $('.frame svg'));
                this.addProperty(theme, 'background', 'fill', $('.background svg'));
                this.addProperty(theme, 'outSide', 'background-color', $('.out-side'));

                theme.add('chandSecond', 'background-color', $('.color-handSecond'), 'handSecond');
                theme.add('chandMinute', 'background-color', $('.color-handMinute'), 'handMinute');
                theme.add('chandHour', 'background-color', $('.color-handHour'), 'handHour');
                theme.add('cnumbers', 'background-color', $('.color-numbers'), 'numbers');
                theme.add('ctimer', 'background-color', $('.color-timer'), 'timer');
                theme.add('cminutes', 'background-color', $('.color-minutes'), 'minutes');
                theme.add('cfiveMinutes', 'background-color', $('.color-fiveMinutes'), 'fiveMinutes');
                theme.add('cframe', 'background-color', $('.color-frame'), 'frame');
                theme.add('cbackground', 'background-color', $('.color-background'), 'background');
                theme.add('coutSide', 'background-color', $('.color-outSide'), 'outSide');

                this.handle(new Profile(this.name, theme, {useSweep: false}));
            },

            handle: function (profile) {
                Appanel['profile'] = profile;

                if (!profile.contains('default')) {
                    profile.save('default', {
                        theme: {
                            handSecond: 'red',
                            handMinute: 'orange',
                            handHour: 'gold',
                            numbers: 'gold',
                            minutes: '#000000',
                            fiveMinutes: '#222222',
                            frame: 'silver',
                            background: 'navy',
                            outSide: 'bluesky'
                        },
                        more: {useSweep: this.options.useSweep, clock: 'original'}
                    });
                }

                var e = $('.theme .profile'),
                    container = e.parents('.profile-container'),
                    template = container[0].innerHTML,
                    clockContainer = $('.clock-container'),
                    clockTemplate = clockContainer[0].innerHTML,
                    bgContainer = $('.background-container'),
                    bgTemplate = bgContainer[0].innerHTML,
                    comContainer = $('.combination-container'),
                    comTemplate = comContainer[0].innerHTML,
                    count = profile.ids.length,
                    theme = profile.theme,
                    themeProperty;

                // handle movement buttons
                Appanel.map([
                    ['.analogue-move', 'click', function () {
                        Appanel.clock.setUseSweep(false);
                    }],
                    ['.smooth-move', 'click', function () {
                        Appanel.clock.setUseSweep(true);
                    }]
                ]);

                // handle combination buttons
                comContainer[0].innerHTML = "";
                for (var i = 0; i < this.combinations.length; i++) {
                    comContainer.append(comTemplate.replace('combination-name', this.combinations[i].name));
                    button = comContainer.find('.combination-item').removeClass('combination-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadCombination(ev.data.index);
                        }, {name: this.combinations[i].name, index: i}]
                    ]);
                }

                // handle add combination button
                Appanel.map([[$('.add-combination'), 'click', function (ev) {
                    Appanel.util.input('New Preset', 'Enter preset name:', Appanel.clock.background,
                        function (data, name) {
                            if (Appanel.clock.combinationIndex(name) >= 0) {
                                Appanel.util.warn('The name ' + name + ' already exists!', 'Try new one that not appear in the list.', 10);
                            } else {
                                Appanel.clock.saveCombination(name);
                                Appanel.util.refresh();
                            }
                        });
                }]]);

                // handle bakground buttons
                bgContainer[0].innerHTML = "";
                for (var i = 0; i < this.backgrounds.length; i++) {
                    bgContainer.append(bgTemplate.replace('background-name', this.backgrounds[i].name));
                    button = bgContainer.find('.background-item').removeClass('background-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.rotateBackground('stop');
                            Appanel.clock.loadBackground(ev.data.index);
                        }, {name: this.backgrounds[i].name, index: i}]
                    ]);
                }

                // handle Auto Change Background button
                Appanel.map([[$('.auto-change-background'), 'click', function (ev) {
                    Appanel.util.input('Time Interval', 'Enter duration before every change of background (in seconds):', '15',
                        function (data, seconds) {
                            if (!$.isNumeric(seconds)) {
                                Appanel.util.warn("Invalid Value", "Time interval need number value like 12345, entered value '" + seconds + "' is not a number!", 10);
                                return;
                            }
                            Appanel.clock.rotateBackground(seconds * 1000);
                        });
                }]]);

                // handle clock buttons
                clockContainer[0].innerHTML = "";
                for (var i = 0; i < this.clocks.length; i++) {
                    clockContainer.append(clockTemplate.replace('clock-name', this.clocks[i].display));
                    button = clockContainer.find('.clock-item').removeClass('clock-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadClock(ev.data.index, function () {
                                this.updateElements();
                                Appanel.profile.theme.updateElements();
                                this.ready();
                            });
                        }, {name: this.clocks[i].name, index: i}]
                    ]);
                    if (this.clocks[i].name === this.clock) button.click();
                }

                // handle profile buttons
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    let profileName = profile.ids[i];
                    container.append(template.replace('profile-name', profileName));
                    button = container.find('.profile').removeClass('profile').addClass('profile-' + profileName);
                    Appanel.map([
                        [button, 'click', function (ev) {
                            var profile = Appanel.profile.load(ev.data.profile),
                                profileName = $('.profile-name');
                            profileName[0].innerText = ev.data.profile;
                            profileName[0].title = 'Current Theme : ' + ev.data.profile;
                        }, {theme: profile.theme, profile: profileName}]
                    ]);
                    if (profileName === profile.current) button.click();
                }

                // handle add profile button
                Appanel.map([[$('.theme .add-profile'), 'click', function (ev) {
                    Appanel.util.input('New Theme', 'Enter theme name:', Appanel.clock.background,
                        function (data, name) {
                            if (Appanel.profile.contains(name)) {
                                Appanel.util.warn(name + ' theme already exists!', 'Try again with another name that not in the list.', 10);
                            } else {
                                Appanel.profile.save(name);
                                Appanel.profile.setCurrent(name);
                                Appanel.util.refresh();
                            }
                        });
                }]]);

                // handle profile name button
                button = $('.theme .profile-name');
                Appanel.map([[button, 'click', function (ev) {
                    var oldName = ev.currentTarget.innerText;
                    Appanel.util.input('Change Theme Name', 'Enter new name:', oldName,
                        function (data, newName) {
                            if (Appanel.profile.contains(newName)) {
                                alert('Profile ' + newName + ' already exists!');
                            } else {
                                Appanel.profile.save(newName);
                                Appanel.profile.remove(data.oldName);
                                Appanel.profile.setCurrent(newName);
                                Appanel.util.refresh();
                            }
                        }, {oldName: oldName});
                }]]);

                // handle color buttons
                var colorPanel = $('.theme .colors'),
                    title, button;
                for (var i in theme) {
                    themeProperty = theme[i];
                    if (i.startsWith('jQuery') || $.isArray(themeProperty) || themeProperty.constructor === Function || themeProperty.sourceProperty != null) continue;
                    button = colorPanel.find('.color-' + i);
                    title = button[0].innerText;
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.util.input(ev.data.title, 'Enter color value:', ev.data.property.get(),
                                function (data, color) {
                                    data.property.set(color);
                                    Appanel.profile.save($('.profile-name')[0].innerText);
                                }, {property: ev.data.property});
                        }, {title: title, property: themeProperty}]
                    ]);
                }
            },

            setTimeout: function (func, millisec) {
                this.clearTimeout();
                this.timeout = window.setTimeout(func, millisec);
            },

            clearTimeout: function () {
                if (this.timeout !== undefined) {
                    clearTimeout(this.timeout);
                    delete this.timeout;
                }
            },

            setInterval: function (func, millisec) {
                this.clearInterval();
                this.interval = window.setInterval(func, millisec);
            },

            clearInterval: function () {
                if (this.interval !== undefined) {
                    clearInterval(this.interval);
                    delete this.interval;
                }
            },

            clearSweep: function ($element, callback) {
                var e, $e, length = $element.length;
                if (length == 0) {
                    console.warn('Ignore clearSweep with zero length');
                    return;
                }

                for (let i = 0; i < $element.length; i++) {
                    e = $element[i];
                    delete e.sweepID;
                    delete e.sweepContext;
                    delete e.chainsID;
                    $e = $(e)
                        .removeClass('ani-clock')
                        .removeClass('css-trans')
                        .css('transform', '')
                        .css('animation-duration', '')
                        .css('animation-iteration-count', '')
                        .css('animation-timing-function', '');
                    Appanel.chains($e, 'ani-clock-reset:0.001');
                }

                if (callback !== undefined) Appanel.clock.setTimeout(function () {
                    callback.call(Appanel.clock);
                }, 10);

                return this;
            },

            updateElements: function () {
                this.$second = $(this.$second.selector);
                this.$minute = $(this.$minute.selector);
                this.$hour = $(this.$hour.selector);
                this.sweeper = $(this.sweeper.selector);
            },

            stop: function (callback) {
                if (this.state !== 'started') {
                    console.warn('Ignore stop at the state', this.state);
                    if (callback !== undefined) callback.call(this);
                    return;
                }

                this.state = 'stopping';
                console.info("clock stop at ", this.hour, ":", this.minute, ":", this.second, ' ', this.options.speed, 'X speed');

                this.clearInterval();
                this.clearTimeout();

                this.setSecond(this.second);
                this.setMinute(this.minute);
                this.setHour(this.hour);

                this.sweeper
                    .off('sweep:ready')
                    .sweep('pause');
                this
                    .clearSweep(this.sweeper)
                    .clearSweep(this.secondHand)
                    .clearSweep(this.minuteHand)
                    .clearSweep(this.hourHand, function () {
                        Appanel.clock.state = 'stop';
                        callback.call(Appanel.clock);
                    });
            },

            start: function (now, speed) {
                var clock = Appanel.clock,
                    sweepAgain = clock.state === 'started' && clock.$second[0].sweepID !== undefined;

                /*avoid invalid second when start after started*/
                if (clock.state === 'started') {
                    console.info('Start at the state', this.state, ' then restart');
                    clock.stop(function () {
                        clock.start(now, speed);
                    });
                    return;
                }

                if (sweepAgain) {
                    clock.stop.call(clock, function () {
                        this.postStart(now, speed);
                    });
                } else {
                    this.postStart(now, speed);
                }
            },

            postStart: function (now, speed) {
                var hour = now.getHours(),
                    minute = now.getMinutes(),
                    second = now.getSeconds(),
                    clock = Appanel.clock,
                    useSweep = clock.options.useSweep,
                    restart = clock.state === 'started';

                clock.state = 'starting';

                if (speed === undefined) speed = 1;
                clock.options.speed = speed;
                console.info("clock start at ", hour, ":", minute, ":", second, ' ', speed, 'X speed');

                clock.ticker = $('.ticker');
                clock.$second = $('.second');
                clock.$minute = $('.minute');
                clock.$hour = $('.hour');
                clock.sweeper = $('.hour,.minute,.second');
                clock.hourHand = clock.$hour.find('svg');
                clock.minuteHand = clock.$minute.find('svg');
                clock.secondHand = clock.$second.find('svg');

                if (useSweep) {
                    var options = {
                        duration: 0.00001,
                        on: "sweep:ready",
                        sweep: []
                    };

                    //1round = 12hours = 60s x 60 x 12 (loop=1day=2rounds)
                    options.sweep.push(this.getSweeper(clock.hourHand, 'ani-clock', 43200, 2));

                    //1round = 60minutes = 60s x 60 (loop=1day=12rounds)
                    options.sweep.push(this.getSweeper(clock.minuteHand, 'ani-clock', 3600, 12));

                    //1round = 1minutes = 60s (loop=1day=43200rounds)
                    options.sweep.push(this.getSweeper(clock.secondHand, 'ani-clock', 60, 3600));

                    clock.sweep = options;
                }

                // force move clock hands
                Appanel.clock.options.useSweep = false;
                clock.setSecond(second);
                clock.setMinute(minute);
                clock.setHour(hour);
                Appanel.clock.options.useSweep = useSweep;

                // delay start
                let delayStart = function () {
                    let clock = Appanel.clock;
                    clock.secondTick();
                    clock.refreshTime();

                    if (clock.options.useSweep) {
                        clock.sweeper
                            .removeClass('css-trans')
                            .sweep(clock.sweep)
                            .sweep('speedx', clock.options.speed);
                    } else {
                        clock.sweeper.addClass('css-trans');
                    }

                    clock.setInterval(function () {
                        Appanel.clock.secondTick();
                        Appanel.clock.refreshTime();
                    }, 1000 * (1 / clock.options.speed));

                };
                Appanel.clock.setTimeout(delayStart, 1000 - now.getMilliseconds());

                clock.state = 'started';
            },

            getSweeper: function (selector, play, duration, loop) {
                return {
                    selector: selector,
                    play: play,
                    timing: 'linear',
                    duration: duration,
                    loop: loop
                };
            },

            clocks: [],

            clockIndex: function (name) {
                var clocks = this.clocks;
                for (var i = 0; i < clocks.length; i++) {
                    if (clocks[i].name === name) return i;
                }
                return 0;
            },

            loadClock: function (clockIndex, callback) {
                var clock = this.clocks[clockIndex],
                    requestDate = (new Date()).toLocaleTimeString(),
                    clockName = clock.name,
                    url = Appanel.util.myURL() + '-' + clockName + '.html?v=' + requestDate;

                this.clock = clockName;
                Appanel.set(this.name + ':clock', clockName);

                // test: get clock from first element
                console.info("Clock URL: ", url);
                $.get(url).complete(function (result, status) {
                    var clockHtml = result.responseText,
                        headStart = clockHtml.indexOf('<head>'),
                        headEnd = clockHtml.indexOf('</head>') + 7,
                        $cover = $('.cover');

                    console.info('load clock completed at ', new Date().toLocaleTimeString());
                    clockHtml = clockHtml.substring(0, headStart) + clockHtml.substring(headEnd + 1);
                    $cover.find('.wrapper > .background')
                        .text('')
                        .append($cover.find('.wrapper > .foreground > .background').html());
                    $cover.find('.wrapper > .foreground').html(clockHtml);

                    if (callback !== undefined) {
                        Appanel.clock.setTimeout(function () {
                            callback.call(Appanel.clock);
                        }, 100);
                    }
                });
            },

            backgrounds: [],

            backgroundIndex: function (name) {
                var backgrounds = this.backgrounds;
                for (var i = 0; i < backgrounds.length; i++) {
                    if (backgrounds[i].name === name) return i;
                }
                return -1;
            },

            loadBackground: function (backgroundIndex) {
                if (backgroundIndex < 0 || backgroundIndex >= this.backgrounds.length) {
                    if (this.backgroundAttributes === undefined) {
                        backgroundIndex = 0;
                    } else {
                        Appanel.util.warn('WARNING', 'backgroundIndex ' + backgroundIndex + ' is out of bound, possible index are 0 - ' + (this.backgrounds.length + 1));
                        return;
                    }
                }

                var bgName = this.backgrounds[backgroundIndex].name;

                this.background = bgName;
                Appanel.set(this.name + ':background', bgName);

                this.setAttributes(this.backgrounds[backgroundIndex]);
            },

            saveBackground: function (name) {
                var index = this.backgroundIndex(name),
                    attributes = this.backgroundAttributes;
                if (index < 0) {
                    this.backgrounds.push({});
                    index = this.backgrounds.length - 1;
                }
                this.backgrounds[index] = Object.assign({
                    name: name,

                    imageWidth: attributes.imageWidth,
                    imageHeight: attributes.imageHeight,
                    imageFilter: attributes.imageFilter,

                    clockXInPercent: attributes.clockXInPercent,
                    clockYInPercent: attributes.clockYInPercent,

                    clockWInPercent: attributes.clockWInPercent,
                    clockHInPercent: attributes.clockHInPercent,

                    clockXDegree: attributes.clockXDegree,
                    clockYDegree: attributes.clockYDegree,
                    clockZDegree: attributes.clockZDegree
                }, (attributes.image === undefined) ? {video: attributes.video} : {image: attributes.image});
                Appanel.set(this.name + ':backgrounds', this.backgrounds);
            },

            rotateBackgroundInterval: null,

            rotateBackground: function (secondsOrStop, startFrom) {
                if (startFrom !== undefined) {
                    this.loadBackground(startFrom);
                }

                if (secondsOrStop !== undefined) {
                    if (this.rotateBackgroundInterval != null) clearInterval(this.rotateBackgroundInterval);
                    if (secondsOrStop === 'stop') return;
                    this.rotateBackgroundInterval = setInterval(function () {
                        Appanel.clock.rotateBackground.call(Appanel.clock);
                    }, secondsOrStop);
                    return;
                }

                var bgIndex = (startFrom === undefined ? this.backgroundIndex(this.background) : startFrom) + 1;
                if (bgIndex < 0 || bgIndex >= this.backgrounds.length) bgIndex = 0;
                if (startFrom === undefined) this.loadBackground(bgIndex);
            },

            /**
             * Set Background Attributes.
             *
             * Example:
             * Appanel.clock.setAttributes({
             *      image: 'img/swiss-railway-clock-scaled.webp',
             *      imageWidth: 2560,
             *      imageHeight: 1707,
             *      imageFilter: 0.25,
             *
             *      clockYInPercent: 0.311,
             *      clockWInPercent: 0.25,
             *
             *      clockXInPercent: 0.5715,
             *      clockHInPercent: 0.37
             * });
             */
            setAttributes: function (attributes) {
                if (this.backgroundAttributes !== undefined) $(window).off('resize', this.backgroundAttributes.resize);

                var $cover = $('.cover'),
                    $background = $('.background-image')
                        .removeClass('css-trans')
                        .css('background-repeat', 'no-repeat');
                this.backgroundAttributes = Object.assign(attributes, {
                    relativeX: 0,
                    relativeY: 0,
                    background: $background,
                    cover: $cover,
                    rotator: $cover.find('.wrapper'),
                    clock: $cover.find('.clock'),
                    resize: function () {
                        var clock = Appanel.clock,
                            a = clock.backgroundAttributes;

                        a.screenW = window.innerWidth;
                        a.screenH = window.innerHeight;

                        a.ratioW = a.screenW / a.imageWidth;
                        a.ratioH = a.screenH / a.imageHeight;

                        if (a.ratioW >= a.ratioH) {
                            a.imageX = 0;
                            a.imageY = (a.screenH - (a.ratioW * a.imageHeight)) / 2;
                            a.imageSize = a.screenW;
                            a.coverX = a.clockXInPercent * a.screenW;
                            a.coverY = a.imageY + (a.ratioW * a.imageHeight * a.clockYInPercent);
                            /*Notice: a.coverSize = (100 * a.clockWInPercent) + 'vw';*/
                            a.coverSize = (100 * a.clockWInPercent) * a.screenW * 0.01;
                        } else {
                            a.imageX = (a.screenW - (a.ratioH * a.imageWidth)) / 2;
                            a.imageY = 0;
                            a.imageSize = a.imageWidth * a.ratioH;
                            a.coverX = a.imageX + (a.ratioH * a.imageWidth * a.clockXInPercent);
                            a.coverY = a.clockYInPercent * a.screenH;
                            /*Notice: a.coverSize = (100 * a.clockHInPercent) + 'vh';*/
                            a.coverSize = (100 * a.clockHInPercent) * a.screenH * 0.01;
                        }

                        a.imageTall = a.imageSize * a.imageWidth / a.imageHeight;

                        /*use relativeX to make equal space between left and right*/
                        let coverSpace = {
                            left: a.coverX,
                            right: (a.coverX + a.coverSize - a.screenW) * -1
                        };
                        if (coverSpace.left === coverSpace.right) {
                            a.relativeX = 0;
                        } else {
                            /*Notice: let backgroundSpace = {
                                left: a.imageX * -1,
                                right: a.imageX + a.imageSize - a.screenW
                            };*/
                            coverSpace.target = (coverSpace.left + coverSpace.right) / 2;
                            coverSpace.moveLeft = coverSpace.left > coverSpace.right;
                            if (coverSpace.moveLeft) {
                                backgroundSpace = a.imageX * -1;
                                a.relativeX = Math.min(coverSpace.left - coverSpace.target, backgroundSpace, coverSpace.left) * -1;
                            } else {
                                backgroundSpace = a.imageX + a.imageSize - a.screenW;
                                a.relativeX = Math.min(coverSpace.right - coverSpace.target, backgroundSpace, coverSpace.right);
                            }
                        }

                        a.background
                            .css('left', (a.imageX + a.relativeX) + 'px')
                            .css('top', (a.imageY + a.relativeY) + 'px')
                            .css('background-size', a.imageSize + 'px')
                            .css('width', a.imageSize + 'px')
                            .css('height', a.imageTall + 'px');

                        if (a.clockPerspective <= 0) {
                            a.cover.css('transform-style', 'flat');
                        } else {
                            a.cover
                                .css('transform-style', 'preserve-3d')
                                .css('transform-origin', a.clockPerspectiveXOrigin + 'px ' + a.clockPerspectiveYOrigin + 'px')
                                .css('transform', 'perspective(' + a.clockPerspective + 'px)');
                        }

                        a.cover
                            .css('left', (a.coverX + a.relativeX) + 'px')
                            .css('top', (a.coverY + a.relativeY) + 'px');

                        a.rotator
                            .css('transform', 'rotate3d(1,0,0,' + a.clockXDegree + 'deg) rotate3d(0,1,0,' + a.clockYDegree + 'deg) rotate3d(0,0,1,' + a.clockZDegree + 'deg)');

                        a.clock
                            .css('width', a.coverSize + 'px')
                            .css('height', a.coverSize + 'px');

                        $(clock).trigger('resize');
                    },
                    member: function (memberName, value) {
                        if (value === undefined) {
                            /* GET VALUE */
                            return this[memberName];
                        } else {
                            /* SET VALUE */
                            this[memberName] = value;
                            this.resize();
                        }
                    }
                });

                this.backgroundAttributes = Object.assign({
                    clockXDegree: 0,
                    clockYDegree: 0,
                    clockZDegree: 0,
                    clockPerspective: 0,
                    clockPerspectiveXOrigin: 0,
                    clockPerspectiveYOrigin: 0
                }, this.backgroundAttributes);

                if (attributes.image === undefined) {
                    $background.css('background-image', '');
                    $background.html('<video autoplay muted loop class="fit-width on-top-left">' +
                        '    <source src="' + attributes.video + '" type="video/mp4">' +
                        '</video>');
                } else {
                    $background
                        .text('')
                        .css('background-image', 'url(' + attributes.image + ')');
                }

                $('.out-side').css('opacity', (100 * this.backgroundAttributes.imageFilter) + '%');

                $(window).on('resize', this.backgroundAttributes.resize);
                this.backgroundAttributes.resize();
            },

            combinations: [],

            combinationIndex: function (name) {
                var combinations = this.combinations;
                for (var i = 0; i < combinations.length; i++) {
                    if (combinations[i].name === name) return i;
                }
                return -1;
            },

            loadCombination: function (combinationIndex) {
                var combination = this.combinations[combinationIndex];
                Appanel.util.disableRefresh = true;

                this.loadClock(this.clockIndex(combination.clock), function () {
                    this.updateElements();
                    Appanel.profile.theme.updateElements();

                    this.start(new Date());

                    this.loadBackground(this.backgroundIndex(combination.background));
                    $('.clock').css('display', 'block');

                    Appanel.profile.load(combination.theme);
                    $('.profile-name').text(combination.theme);

                    if (combination.options !== undefined) {
                        this.options = combination.options;
                        this.setUseSweep(combination.options.useSweep);
                    }

                    Appanel.util.disableRefresh = false;
                });
            },

            saveCombination: function (name) {
                var index = this.combinationIndex(name);
                if (index < 0) {
                    this.combinations.push({});
                    index = this.combinations.length - 1;
                }
                this.combinations[index] = {
                    name: name,
                    clock: this.clock,
                    theme: Appanel.profile.current,
                    background: this.background,
                    options: this.options
                };
                Appanel.set(this.name + ':combinations', this.combinations);
            },

            loadJSONLocal: function (name, callback) {
                var localName = this.name + ':' + name,
                    json = Appanel.get(localName);
                if (json == null) return false;

                this[name] = json;
                if ($.isFunction(callback)) callback.call(this, localName);
                return true;
            },

            loadJSON: function (name, callback) {
                if (name !== 'control' && this.control[name] <= this.defaults.control[name]) {
                    if (this.loadJSONLocal(name, callback)) return;
                }

                var requestDate = (new Date()).toLocaleTimeString(),
                    uri = Appanel.util.myURL() + '-' + name + '.json',
                    myJson = encodeURI(uri + '?v=' + requestDate);

                //console.info("JSON URL: ", myJson);
                this.lastLoadJSON = $.getJSON(myJson)
                    .complete(function (json, status) {
                        //console.info('load ', name, 'completed at ', new Date().toLocaleTimeString());
                        Appanel.clock[name] = json.responseJSON;
                        Appanel.set(Appanel.clock.name + ':' + name, json.responseJSON);
                        if ($.isFunction(callback)) callback.call(Appanel.clock, uri);
                    });
                this.lastLoadJSON.fail(function (ev) {
                    //console.error('load ', name, 'failed at ', new Date().toLocaleTimeString(), ':', ev.status, ev.statusText);
                    Appanel.util.warn('WARNING', 'load ' + name + ' json failed with ' + ev.status + ':' + ev.statusText, 30);
                    Appanel.clock[name] = Appanel.clock.defaults[name];

                    var loadStatus = ev.status;
                    if (Appanel.clock.defaults[name] !== undefined) {
                        loadStatus = 'default';
                    } else {
                        loadStatus = status /*ev.status*/;
                    }

                    if ($.isFunction(callback)) callback.call(Appanel.clock, loadStatus);
                });
            },

            load: function () {
                var control = Appanel.get(this.name + ':control');
                if (control !== null) this.defaults.control = control;

                this.loadOptions();
                this.setUseSweep(this.options.useSweep);

                this.loadJSON('control', function (status) {
                    console.info('Control loaded from ' + status);
                    this.loadJSON('clocks', function (status) {
                        if (status === 'parsererror') {
                            this.clocks = [];
                            Appanel.util.warn('IMPORTANT', 'load clock list failed the "' + Appanel.util.myURL() + '-clocks.json" may be corrupted', 20);
                            return;
                        }
                        console.info('Clocks loaded from ' + status);
                        this.loadClock(this.clockIndex(Appanel.get(this.name + ':clock')), Appanel.clock.ready);
                    });
                    this.loadJSON('backgrounds', function (status) {
                        if (status === 'parsererror') {
                            this.backgrounds = [];
                            Appanel.util.warn('IMPORTANT', 'load background list failed the "' + Appanel.util.myURL() + '-backgrounds.json" may be corrupted', 20);
                            return;
                        }
                        console.info('Backgrounds loaded from ' + status);
                    });
                    this.loadJSON('combinations', function (status) {
                        if (status === 'parsererror') {
                            this.backgrounds = [];
                            Appanel.util.warn('IMPORTANT', 'load combination list failed the "' + Appanel.util.myURL() + '-combinations.json" may be corrupted', 20);
                        }
                        console.info('Combinations loaded from ' + status);
                    });
                });
            },

            createMinutes: function (container, degrees, count) {
                var template = container[0].innerHTML;
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    if (degrees[i] === 0) continue;
                    container.append(template.replace('number-id', 'number-' + i));
                    container.find('.number-' + i).css('transform', 'rotate(' + degrees[i] + 'deg)');
                }
            },

            disableActivated: false,

            activated: function () {
                var clock = Appanel.clock;
                if (clock.disableActivated) {
                    console.warn('Ignore activated by switch disableActivated is ', clock.disableActivated);
                    return;
                }

                clock.loadClock(clock.clockIndex(clock.clock), function () {
                    clock.updateElements();
                    Appanel.profile.theme.updateElements();
                    clock.ready();
                });

                /*Appanel.clock.stop(function () {
                    Appanel.clock.start(new Date(), Appanel.clock.options.speed);
                });*/
            },

            ready: function () {
                var firstTime = this.state === 'initialized';
                this.start(new Date());
                /*this.start(new Date(2022, 12, 25, 17, 59, 59), 1);*/

                // need to show after started
                this.loadBackground(this.backgroundIndex(Appanel.get(this.name + ':background')));
                $('.clock').css('display', 'block');

                if (firstTime) {
                    this.initProfile();
                    $(window).on('focus', this.activated);
                } else {
                    Appanel.profile.load(Appanel.profile.current);
                }
            }

        },

        ui: {
            setTimeout: function (func, millisec) {
                this.clearTimeout();
                this.timeout = window.setTimeout(func, millisec);
            },

            clearTimeout: function () {
                if (this.timeout !== undefined) {
                    clearTimeout(this.timeout);
                    delete this.timeout;
                }
            },

            resize: function () {
                var ui = Appanel.ui;
                ui.setTimeout(function () {
                    var maxHeight = window.innerHeight * 0.5;
                    $('.ui.scrollable').css('max-height', maxHeight);
                }, 1000);
            },

            init: function () {
                this.resize();
                $(window).on('resize', this.resize);
            }
        },

        ready: function () {
            Appanel.clock.load();
            Appanel.ui.init();
            Appanel.util.refreshAfter(3600);
        }
    });
</script>

</body>
</html>
