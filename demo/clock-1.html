<!DOCTYPE html>
<html>

<head>
    <title>Analog Clock using focus-3.html</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="focus-3.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/sym-fa.css" media="all"/>
    <link rel="stylesheet" type="text/css" href="http://localhost/scbs/css/ani-anicss.css"/>
    <style>
        @keyframes ani-clock-reset {
            100% {
                transform: rotate(0deg);
            }
        }

        @keyframes ani-clock {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .ani-clock {
            -webkit-animation-name: ani-clock;
            animation-name: ani-clock;
        }

        .ani-clock-reset {
            -webkit-animation-name: ani-clock-reset;
            animation-name: ani-clock-reset;
        }

        @keyframes ani-hide-circle-progress {
            0% {
                stroke-dashoffset: 0;
            }
            100% {
                stroke-dashoffset: -31.415926535897932384626433832795;
            }
        }

        .ani-hide-circle-progress {
            -webkit-animation-name: ani-hide-circle-progress;
            animation-name: ani-hide-circle-progress;
            animation-timing-function: linear;
        }

        .item-container {
            display: flex;
            flex-direction: column;
        }

        .item-fit-available {
            flex: /*available*/ 1;
            display: block;
        }

        .item-fit-available.scrollable {
            background-color: rgba(0, 0, 0, 0.7);
        }

        .cover {
            position: absolute;
            width: 100vh;
            height: 100vh;
            left: calc((100vw - 100vh) / 2);
        }

        .clock {
            position: absolute;
            width: 100vh;
            height: 100vh;
            display: none;
        }

        .clock-ui {
            height: calc(100vh - 20px);
        }

        .clock-ui .board {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .clock-ui:hover .board {
            width: 350px;
            max-width: calc(100vw - 10px);
        }

        .debug {
            height: 10vh;
            overflow: visible;
        }

        .debug .board {
            border-color: rgba(255, 255, 255, 0.5);
        }

        .debug:hover .board {
            width: 350px;
        }

        .css-trans {
            transition-duration: 0.2s;
        }

        .css-trans--x2 {
            transition-duration: 0.4s;
        }

        .zoom-ui svg {
            opacity: 0;
        }

        .zoom-ui:hover svg {
            opacity: 1;
        }

        .volume circle,
        .volume line {
            cursor: grab;
        }

        .grabbing,
        .grabbing .volume circle,
        .grabbing .volume line {
            cursor: grabbing;
        }
    </style>
</head>

<body class="css-trans fixed background--c0 fit-width fit-height no-select" style="font-family: Arial,sans-serif;">

<!-- background -->
<div class="background-image fit-width fit-height layer-1">
    <!-- filter -->
    <div class="out-side on-top-left fit-width fit-height">
        <div class="on-top fixed">
            <h1 class="footprint capital padding--x10 opacity--x0 opacity--x100--at">Analogue Clock v1</h1><br/>
        </div>
    </div>
</div>

<!-- clock -->
<div class="cover layer-3">
    <div class="clock wrapper rounded--x20">
        <div class="clock background">
            <!-- store all shapes for clock background and frame -->
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 200 200" stroke="red" stroke-width="2" fill="black" class="fit-width">
                <defs>
                    <filter id="drop-shadow-right">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="0.5"/>
                        <feOffset dx="2" dy="2" result="offsetblur"/>
                        <feFlood flood-color="rgba(0,0,0,0.5)"/>
                        <feComposite in2="offsetblur" operator="in"/>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    <filter id="drop-shadow-left">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="0.5"/>
                        <feOffset dx="-2" dy="-2" result="offsetblur"/>
                        <feFlood flood-color="rgba(0,0,0,0.5)"/>
                        <feComposite in2="offsetblur" operator="in"/>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <polygon id="none" points="0,0 1,0 1,1 0,1" stroke-opacity="1" stroke-linecap="square" class="shape hidden"></polygon>
                <circle id="circle" cx="100" cy="100" r="98" stroke-opacity="1" stroke-linecap="square" class="shape hidden"></circle>
                <rect id="rectangle" x="1" y="0" width="198" height="200" rx="10" stroke-opacity="1" stroke-linecap="square" class="shape hidden"></rect>
            </svg>
        </div>
        <div class="clock foreground">
            <!-- this content will be replaced by clock -->
        </div>
        <div class="clock glass layer-4">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 200 200" fill="transparent" stroke="transparent" class="fit-width">
                <circle id="top-switch" class="layer-9" cx="100" cy="50" r="40"></circle>
                <circle id="center-switch" class="layer-9" cx="100" cy="100" r="40"></circle>
            </svg>
        </div>
        <!-- UI:Zoom Panel -->
        <div class="clock zoom-ui">
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" viewBox="0 0 200 200" class="fit-width volume css-trans--x2">
            <circle cx="100" cy="100" r="26"
                    fill="black" stroke="black"
                    stroke-opacity="1"
                    stroke-width="1"
                    stroke-linecap="butt"
                    stroke-linejoin="round"
                    stroke-dashoffset="0"
                    stroke-dasharray="1"/>
                <circle cx="100" cy="100" r="18"
                        fill="red" stroke="red"
                        stroke-opacity="1"
                        stroke-width="3"
                        stroke-linecap="butt"
                        stroke-linejoin="round"
                        stroke-dashoffset="0"
                        stroke-dasharray="3"/>
                <circle cx="100" cy="100" r="13" fill="black" stroke="transparent" stroke-width="1" class="opacity--x50"/>
                <line x1="100" x2="100" y1="95" y2="88" stroke="white" stroke-width="3.5" stroke-linecap="round"></line>
        </svg>
        </div>
    </div>
</div>

<!-- UI:Side Panel -->
<div class="clock-ui on-left fixed css-trans--x2 width--x100 opacity--x0 opacity--x100--at layer-5">
    <div class="board css-trans fit-height width--x1 right-rounded--x20 bottom-rounded--x20 top-border--x10 right-border--x10 bottom-border--x10 on-left">
        <div class="drilldown fit-width item-container">

            <!-- combination -->
            <div class="combinations css-trans">
                <div class=" next button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Presets</div>
                <div class="sub">
                    <div class="inner item-container center-text fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Presets</div>

                        <div class="ui item-fit-available scrollable combination-container columns">
                            <div class="column-8-10 combination-item button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70 left-text">&nbsp;combination-name</div>
                            <div class="column-2-10 save button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-save symbol--c3 middle-text"></span></div>
                        </div>

                        <span class="add-combination button background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
                    </div>
                </div>
            </div>

            <!-- clocks -->
            <div class="clocks css-trans">
                <div class=" next button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Clock Faces</div>
                <div class="sub">
                    <div class="inner item-container center-text fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Clock Faces</div>

                        <div class="ui item-fit-available scrollable clock-container">
                            <span class="clock-item button child background--c1 background--c0--at opacity--x70 padding--x10 left-text">clock-name</span>
                        </div>
                        <span class="bottom-child background--c3 opacity--x70 padding--x10"></span>
                    </div>
                </div>
            </div>

            <!-- colors -->
            <div class="themes css-trans">
                <div class=" next button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Color Themes</div>
                <div class="sub theme">
                    <div class="inner item-container center-text fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Color Themes</div>

                        <div class="ui item-fit-available scrollable profile-container columns">
                            <div class="profile button column-8-10 background--c1 background--c0--at top-padding--x10 bottom-padding--x10 opacity--x70 left-text">profile-name</div>
                            <div class="profile next button column-2-10 background--c1 background--c0--at top-padding--x10 bottom-padding--x10 opacity--x70"><span class="right-symbol sym-chevron-right symbol--c3 middle-text"></span></div>
                            <div class="sub">
                                <div class="inner item-container center-text fit-height">
                                    <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span><span class="profile-name ">Theme Name</span></div>

                                    <div class="colors item-fit-available">
                                        <div class="ui scrollable fit-height">
                                            <span class="color-handSecond button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Second Hand Color</span>
                                            <span class="color-handMinute button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minute Hand Color</span>
                                            <span class="color-handHour button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Hour Hand Color</span>
                                            <span class="color-numbers button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Numbers Color</span>
                                            <span class="color-timer button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Timer Color</span>
                                            <span class="color-minutes button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Minutes Color</span>
                                            <span class="color-fiveMinutes button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Five Minutes Color</span>
                                            <span class="color-background button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Background Color</span>
                                            <span class="color-frame button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Border Color</span>
                                            <span class="color-border button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Border Size</span>
                                            <span class="color-outSide button child background--c1 background--c0--at opacity--x70 padding--x10 left-text symbol sym-dot-circle-o symbol--c3"> Filter Color</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <span class="add-profile button bottom-child background--c3 background--c0--at opacity--x70 padding--x10 center-text">+</span>
                    </div>
                </div>
            </div>

            <!-- animation selector -->
            <div class="behaviors css-trans">
                <div class=" next button child padding--x10 opacity--x70 padding--x10 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Clock Behaviors</div>
                <div class="sub">
                    <div class="inner center-text fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Clock Behaviors</div>

                        <span class="analogue-move button top-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at">Analogue Move</span>
                        <span class="smooth-move button bottom-child border--x4 background--c3 background--c0--at opacity--x70 border--x3 border--c3 padding--x10 symbol text--c0 text--c3--at">Smooth Move</span>

                    </div>
                </div>
            </div>

            <!-- backgrounds -->
            <div class="backgrounds css-trans">
                <div class=" next button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Background & Shapes</div>
                <div class="sub">
                    <div class="inner item-container center-text fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Background & Shapes</div>

                        <div class="ui item-fit-available scrollable background-container columns">
                            <div class="column-7-10 background-item button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70 left-text">&nbsp;background-name</div>
                            <div class="column-1-10 edit button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-edit symbol--c3 middle-text" title="Change Name"></span></div>
                            <div class="column-1-10 save button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-arrows-alt symbol--c3 middle-text" title="Position the Clock"></span></div>
                            <div class="column-1-10 delete button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-times-circle symbol--c3 middle-text" title="Delete the Background"></span></div>
                        </div>

                        <div class="bottom-child columns">
                            <span class="column-1-2 auto-change-background button background--c3 background--c0--at opacity--x70 bottom-padding--x10 top-padding--x10 center-text">As Slide</span>
                            <span class="column-1-2 add-background button background--c3 background--c0--at opacity--x70 bottom-padding--x10 top-padding--x10 center-text">+</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- browser -->
            <div class="browser css-trans">
                <div class=" next button child padding--x10 opacity--x70 padding--x10 background--c3 background--c0--at text--c0 text--c3--at right-symbol sym-chevron-right">Browser Functions</div>
                <div class="sub">
                    <div class="inner item-container fit-height">
                        <div class="back button child opacity--x70 padding--x10 padding--x10 background--c3 background--c0--at text--c0 text--c3--at center-text"><span class="pull-left symbol sym-chevron-left"></span>Browser Functions</div>

                        <div class="window-sizes ui item-fit-available scrollable">
                            <div class="full-screen button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at left-text">Full Screen</div>
                            <div class="thin-window button child padding--x10 opacity--x70 background--c3 background--c0--at text--c0 text--c3--at left-text">Thin Window</div>

                            <div class="child padding--x10 opacity--x70 background--c3 text--c0 center-text">:: Window Position & Sizes ::</div>
                            <div class="window-size-container columns">
                                <div class="column-8-10 window-size-item button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70 left-text">&nbsp;window-size-name</div>
                                <div class="column-1-10 edit button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-edit symbol--c3 middle-text" title="Edit Window Size"></span></div>
                                <div class="column-1-10 delete button top-padding--x10 bottom-padding--x10 background--c1 background--c0--at opacity--x70"><span class="symbol sym-times-circle symbol--c3 middle-text" title="Delete this size"></span></div>
                            </div>
                        </div>

                        <span class="bottom-child add-window-size button background--c3 background--c0--at opacity--x70 bottom-padding--x10 top-padding--x10 center-text">+</span>
                    </div>
                </div>
            </div>

            <!-- playground -->
            <div class="playground item-fit-available background--c0 opacity--x60">
                <div class=" on-center no-wrap ellipsis left-text max-width--x100pc"><span class="current-info">PLAYGROUND</span></div>
                <i class="on-bottom-right footprint capital padding--x10 text--c1">Analogue Clock v1</i>
            </div>

        </div>
    </div>
</div>

<!-- UI:Messages -->
<div class="message-container on-top-left fixed css-trans--x2 layer-9">
    <!-- message will be show here -->
</div>
<div class="debug messages on-bottom-right fixed css-trans--x2 rounded--x50 width--x50 height--x50 layer-9 background-c0">
    <div class="board on-bottom-right css-trans--x2 top-rounded--x30 background--c0 width--x1 opacity--x0 opacity--x80--at">
        <div class="top-padding--x10 left-padding--x10 top-rounded--x30 top-border--x10 left-border--x10 border--c3">
            <div class="top-padding--x10 bottom-padding--x10 top-rounded--x20 left-rounded--x20 background--c3 center-text no-wrap fit-width">DEBUG MESSAGES</div>
            <div class="debug-message padding--x10 left-text fit-width ellipsis no-wrap">DEBUG MESSAGES HERE</div>
        </div>
    </div>
</div>

<!-- JS -->
<script type="text/javascript" src="http://localhost/jquery/1.11/jquery.js"></script>
<script type="text/javascript" src="../dist/jquery.panel.suite.min.js"></script>
<script type="text/javascript" src="../src/jquery.theme.js?version=1"></script>
<script type="text/javascript" src="demo-util.js?refresh=1"></script>
<script>
    window['APanel'] = function (panel, minWidth, minHeight, hide) {
        this.element = panel;
        if (minWidth !== undefined) this.minWidth = minWidth;
        if (minHeight !== undefined) this.minHeight = minHeight;
        if (hide !== undefined) this.hide = hide;
    };
    window.APanel.prototype = {
        /* true = hide, false = zoom */
        hide: true,
        /* hide menu when window.innerWidth < minWidth (do same thing for Height) */
        minWidth: 356,
        minHeight: 320,
        element: $('.a-panel'),
        resize: function (width, height) {
            Appanel.clock.ui.debug(`${this.element.selector}.resize:\nwidth=${width} height=${height}`);
            let diffW = width - this.minWidth,
                diffH = height - this.minHeight,
                reach = diffW < 0 || diffH < 0;
            if (this.hide) {
                if (reach) {
                    this.element.addClass('hidden');
                } else {
                    this.element.removeClass('hidden');
                }
            } else if (reach) {
                let zoom = (diffW < 0) ? width / this.minWidth : height / this.minHeight;
                this.element.css('zoom', zoom);
            } else {
                this.element.css('zoom', 1);
            }
        }
    };
    Appanel({
        clock: {

            ui: {
                debugMessage: '',
                debugCount: 0,
                debugMax: 12,
                debugId: 0,
                debug: function (message) {
                    this.debugMessage += (this.debugId++) + ') ' + message.replaceAll('\n', '<br>&nbsp;&nbsp;') + '<br/>';

                    /*lines limit*/
                    let i;
                    this.debugCount++;
                    while (this.debugCount > this.debugMax) {
                        i = this.debugMessage.indexOf('<br/>');
                        this.debugMessage = this.debugMessage.substr(i + 5);
                        this.debugCount--;
                    }

                    this.$debug.html(this.debugMessage);
                },

                refreshCurrentInfo: function () {
                    /*if (Appanel.util.disableRefresh) {
                        console.warn('');
                        return;
                    }*/

                    var clock = Appanel.clock,
                        profile = Appanel.profile,
                        preset = clock.combination === undefined ? 'custom' : clock.combination,
                        theme = profile === undefined ? 'none' : profile.current,
                        useSweep = clock.options.useSweep ? 'Smooth Move' : 'Analogue Move',
                        version = `${clock.name} v.${clock.control.version}.${clock.control.clocks}.${clock.control.backgrounds}.${clock.control.combinations}`;
                    $('.current-info').html(
                        `
                        Preset: ${preset}<br/>
                        Clock: ${clock.clock} (${useSweep})<br/>
                        Theme: ${theme}<br/>
                        Background: ${clock.background}
                        `
                    );
                    $('.footprint').text(version);
                },

                menu: new APanel($('.clock-ui.fixed'), 56, 56),
                menuFootPrint: new APanel($('.clock-ui.fixed .footprint'), 360, 512),
                menuPlayGround: new APanel($('.clock-ui.fixed .current-info'), 360, 420),
                dev: new APanel($('.debug.messages'), 310, 320, false),

                resize: function () {
                    this.menu.resize(window.innerWidth, window.innerHeight);
                    this.menuFootPrint.resize(window.innerWidth, window.innerHeight);
                    this.menuPlayGround.resize(window.innerWidth, window.innerHeight);
                    this.dev.resize(window.innerWidth, window.innerHeight);
                },

                zoom: {
                    currentZoom: 1,
                    minZoom: 1,
                    maxZoom: 3,
                    maxDegree: 355,
                    volume: $('.zoom-ui') /*must be rotate parent of volume(svg)*/,
                    body: $('body')
                },

                setZoom: function (newZoom) {
                    let zoom = this.zoom,
                        clock = Appanel.clock;

                    if (zoom.currentZoom === newZoom) {
                        return;
                    }

                    /*update zoom value*/
                    zoom.currentZoom = newZoom;
                    clock.options.currentZoom = newZoom;
                    clock.saveOptions();

                    /*present volume degree*/
                    let length = zoom.maxZoom - zoom.minZoom,
                        current = newZoom - zoom.minZoom,
                        percent = current / length,
                        degree = percent * zoom.maxDegree;
                    zoom.currentPercent = percent;
                    zoom.currentDegree = degree;
                    zoom.volume.css('transform', 'rotate(' + degree + 'deg)');
                },

                captureSwitch: function (switchPosition) {
                    $('.wrapper > .glass #' + switchPosition + '-switch')
                        .off('mouseenter')
                        .on('mouseenter', function () {
                            //console.debug('clock:' + switchPosition + '-switch');
                            $(Appanel.clock).trigger('clock:' + switchPosition + '-switch');
                        })
                },

                handleSwitch: function (switchPosition, uiSelector) {
                    $(Appanel.clock).off('clock:' + switchPosition + '-switch')
                        .on('clock:' + switchPosition + '-switch', function () {
                            $(uiSelector).removeClass('layer-5').addClass('layer-5');
                        })
                    ;
                    $(uiSelector).off('mouseover mouseout')
                        .on('mouseout', function () {
                            $(uiSelector).removeClass('layer-5');
                        })
                        .on('mouseover', function () {
                            $(uiSelector).addClass('layer-5');
                        })
                    ;
                },

                sizeIndex: function (name) {
                    var sizes = this.sizes;
                    for (var i = 0; i < sizes.length; i++) {
                        if (sizes[i].name === name) return i;
                    }
                    return -1;
                },

                loadSizes: function () {
                    this.sizes = Appanel.get(Appanel.clock.name + ':sizes');
                    if (this.sizes == null) {
                        this.sizes = [];
                    }
                },

                loadSize: function (index) {
                    let size = this.sizes[index];
                    if (size === undefined) {
                        Appanel.util.warn(`Index(${index}) out of bound(${this.sizes.length}), window size has not changed`);
                        return;
                    }
                    window.moveTo(size.left, size.top);
                    window.resizeTo(size.width, size.height);
                },

                saveSize: function (name, left, top, width, height) {
                    if (name !== undefined) {
                        let index = this.sizeIndex(name);
                        if (index < 0) {
                            index = this.sizes.length;
                            this.sizes.push({});
                        }
                        this.sizes[index] = {
                            name: name,
                            left: left,
                            top: top,
                            width: width,
                            height: height
                        };
                    }
                    Appanel.set(Appanel.clock.name + ':sizes', this.sizes);
                },

                handleSizes: function () {

                    // handle size buttons
                    let comContainer = $('.window-size-container'),
                        comTemplate = this.sizeButtonTemplate === undefined ? comContainer[0].innerHTML : this.sizeButtonTemplate,
                        button, editButton, deleteButton,
                        editSize = function (ev) {
                            let predefined = ev.data.index >= 0 ? ev.data.ui.sizes[ev.data.index] : {
                                    name: '',
                                    left: window.screenX,
                                    top: window.screenY,
                                    width: window.outerWidth,
                                    height: window.outerHeight
                                },
                                inputsOpen = function (ev) {
                                    let panel = $(ev.currentTarget),
                                        inputs = panel.find('input[type=number]'),
                                        button = $('<div class="button background--c3 background--c0--at symbol sym-refresh"></div>'),
                                        buttons;

                                    /* add refresh button */
                                    panel.find('label').parent().after(button);
                                    buttons = panel.find('.sym-refresh');

                                    /* handle reset button */
                                    Appanel.map([[buttons, 'click', function (ev) {
                                        let inputs = ev.data.inputs;
                                        inputs[0].value = window.screenX;
                                        inputs[1].value = window.screenY;
                                        inputs[2].value = window.outerWidth;
                                        inputs[3].value = window.outerHeight;
                                    }, {inputs: inputs, predefined: ev.data.predefined}]]);
                                },
                                inputs = {
                                    title: 'Window Position & Size',
                                    inputs: [
                                        {
                                            label: 'Name:',
                                            placeHolder: 'unique name here',
                                            defaultValue: predefined.name,
                                            type: 'text'
                                        },
                                        {
                                            label: 'Left:',
                                            placeHolder: '',
                                            defaultValue: predefined.left,
                                            type: 'number'
                                        },
                                        {
                                            label: 'Top:',
                                            placeHolder: '',
                                            defaultValue: predefined.top,
                                            type: 'number'
                                        },
                                        {
                                            label: 'Width:',
                                            placeHolder: '',
                                            defaultValue: predefined.width,
                                            type: 'number'
                                        },
                                        {
                                            label: 'Height:',
                                            placeHolder: '',
                                            defaultValue: predefined.height,
                                            type: 'number'
                                        }
                                    ],
                                    data: {
                                        ui: Appanel.clock.ui,
                                        predefined: predefined
                                    },
                                    handler: function (data, enteredValues) {
                                        let name = enteredValues[0].trim();
                                        if (name === '') {
                                            Appanel.util.warn('The name can not be blank', '', 5);
                                            for (let i = 1; i < 5; i++) {
                                                data.inputs.inputs[i].defaultValue = enteredValues[i];
                                            }
                                            Appanel.map([[Appanel.util.inputs(data.inputs), 'selection:open', inputsOpen, {predefined: {name: data.predefined.name, left: enteredValues[1], top: enteredValues[2], width: enteredValues[3], height: enteredValues[4]}}]]);
                                        } else if (data.predefined.name === '' && data.ui.sizeIndex(name) >= 0) {
                                            Appanel.util.warn('The name ' + name + ' already exists!', 'Try new one that not appear in the list.', 10);
                                        } else {
                                            data.ui.saveSize(name, enteredValues[1], enteredValues[2], enteredValues[3], enteredValues[4]);
                                            Appanel.util.info('SAVED', 'New window size named "' + name + '" is saved');
                                            if (data.predefined.name === '') data.ui.handleSizes();
                                        }
                                    }
                                };
                            inputs.data.inputs = inputs;
                            Appanel.map([[Appanel.util.inputs(inputs), 'selection:open', inputsOpen, {predefined: predefined}]]);
                        };
                    this.sizeButtonTemplate = comTemplate;

                    comContainer[0].innerHTML = "";
                    for (let i = 0; i < this.sizes.length; i++) {
                        comContainer.append(comTemplate.replace('window-size-name', this.sizes[i].name));
                        button = comContainer.find('.window-size-item').removeClass('window-size-item');
                        editButton = comContainer.find('.edit').removeClass('edit');
                        deleteButton = comContainer.find('.delete').removeClass('delete');
                        Appanel.map([
                            [button, 'click', function (ev) {
                                Appanel.clock.ui.loadSize(ev.data.index);
                            }, {name: this.sizes[i].name, index: i}],
                            [editButton, 'click', editSize, {ui: this, index: i}],
                            [deleteButton, 'click', function (ev) {
                                if (Appanel.clock.ui.sizes.length <= 1) {
                                    Appanel.util.warn('Requires at least one size, if you want to delete this size please add another before.', 15);
                                    return;
                                }

                                let dialogue = Appanel.selection('question', 'Delete Size', 'Are you sure you want to delete size "' + ev.data.name + '" this can not undo?', {buttons: ['Yes', 'No']});
                                Appanel.map([[dialogue, 'selection:closed', function (ev, button) {
                                    if (button.button === 'Yes') {
                                        let name = ev.data.name,
                                            ui = Appanel.clock.ui,
                                            index = ui.sizeIndex(name),
                                            buttons = ev.data.buttons;

                                        ui.sizes.splice(index, 1);
                                        for (let i in buttons) {
                                            buttons[i].remove();
                                        }
                                        ui.saveSize();

                                        Appanel.util.info('DELETED', 'Size "' + ev.data.name + '" is deleted.');
                                    }
                                }, ev.data]]);

                            }, {name: this.sizes[i].name, index: i, buttons: [button, editButton, deleteButton]}]
                        ]);
                    }

                    // add new size
                    Appanel.map([[$('.add-window-size'), 'click', editSize, {ui: this, index: -1}]]);

                },

                handle: function () {
                    /*handle switches*/
                    this.captureSwitch('top');
                    this.captureSwitch('center');
                    this.handleSwitch('center', '.zoom-ui');
                    this.handleSizes();

                    /*handle zoom volume on ui-panel*/
                    $('.zoom-ui .volume').off('mousedown')
                        .on('mousedown', function (ev) {
                            var clock = Appanel.clock,
                                zoom = clock.ui.zoom;
                            Appanel.clock.ui.zoom = Object.assign(zoom, {
                                grabbing: true,
                                calculated: true,
                                startX: ev.clientX,
                                startY: ev.clientY,
                                startXY: ev.clientX + ev.clientY,
                                startZoom: zoom.currentZoom === undefined ? 1 : zoom.currentZoom,
                                timeout: new Appanel.Timeout()
                            });

                            /*start grabbing volume*/
                            zoom.body.addClass('grabbing')
                                .on('mousemove', function (ev) {
                                    var ui = Appanel.clock.ui,
                                        zoom = ui.zoom;

                                    /*stop grabbing by mouse-button-release not start from the volume*/
                                    if (!zoom.grabbing || ev.buttons === 0) {
                                        zoom.body
                                            .off('mousemove')
                                            .removeClass('grabbing');
                                        return;
                                    }

                                    /*ignore new message when the last message is not finish*/
                                    if (!zoom.calculated) return;
                                    zoom.calculated = false;

                                    /*zoom by relative position*/
                                    var diffX = (ev.clientX + ev.clientY) - zoom.startXY,
                                        newZoom = zoom.startZoom + (diffX * 0.001),
                                        update = newZoom !== zoom.currentZoom,
                                        $body = $(ev.currentTarget);
                                    newZoom = Math.max(newZoom, zoom.minZoom);
                                    newZoom = Math.min(newZoom, zoom.maxZoom);
                                    zoom.currentX = ev.clientX;
                                    zoom.currentY = ev.clientY;

                                    ui.setZoom(newZoom);
                                    zoom.calculated = true;

                                    if (update) zoom.timeout.set(Appanel.clock.backgroundAttributes.resize, 100);
                                });
                        });

                    $(window).on('resize', function () {
                        Appanel.clock.ui.resize.call(Appanel.clock.ui)
                    });
                },

                initDrilldown: function () {
                    $('.drilldown').drilldown({
                        //debug: true,
                        //live: '.live',
                        //iframe: '.iframe'
                    });
                },

                init: function () {
                    this.$debug = $('.debug-message');
                    this.timeout = new Appanel.Timeout();
                    this.initDrilldown();
                    this.resize();
                    this.loadSizes();
                    this.handle();
                }
            },

            name: 'analogue-clock',
            state: 'initialized',

            defaults: {
                options: {
                    useSweep: false,
                    speed: 1,
                    currentZoom: 1
                },
                clocks: [],
                backgrounds: [],
                combinations: [],
                control: {
                    clocks: 0,
                    backgrounds: 0,
                    combainations: 0
                },
                backgroundAttributes: {
                    imageFilter: 0.25,
                    scale: 1.0,
                    relativeX: 0,
                    relativeY: 0,
                    disableRelativeX: false,
                    disableRelativeY: false,
                    clockShape: {
                        "id": "circle"
                    },
                    clockXDegree: 0,
                    clockYDegree: 0,
                    clockZDegree: 0,
                    clockPerspective: 800,
                    clockPerspectiveXOrigin: 0,
                    clockPerspectiveYOrigin: 0
                }
            },

            loadOptions: function () {
                var options = Appanel.get(this.name + ':options');

                this.options = Object.assign({}, this.defaults.options);
                if (options != null) {
                    this.options = Object.assign(this.options, options);
                }

                this.ui.setZoom(this.options.currentZoom);
                this.setUseSweep(this.options.useSweep);
            },

            saveOptions: function () {
                Appanel.set(this.name + ':options', this.options);
            },

            setUseSweep: function (useSweep) {
                if (useSweep == null) useSweep = false;
                var changed = this.options.useSweep !== useSweep;
                this.options.useSweep = useSweep;

                var active, inactive;
                if (useSweep) {
                    inactive = '.analogue-move';
                    active = '.smooth-move';
                } else {
                    active = '.analogue-move';
                    inactive = '.smooth-move';
                }
                $(active).css('background-color', 'yellow');
                $(inactive).css('background-color', 'silver');

                if (changed && this.state === 'started') {
                    this.ui.refreshCurrentInfo();
                    this.saveOptions();
                    this.start(new Date(), this.options.speed);
                }
            },

            shadow: function ($element, percent) {
                let id;
                if (percent > 0.98) id = 'drop-shadow-top';
                else if (percent > 0.52) id = 'drop-shadow-left';
                else if (percent > 0.48) id = 'drop-shadow-bottom';
                else if (percent > 0.02) id = 'drop-shadow-right';
                else id = 'drop-shadow-top';
                $element.find('.shadow').attr('filter', 'url(#' + id + ')');
            },

            setSecond: function (second) {
                this.percentSecond = second / 60;
                if (!this.options.useSweep) {
                    if (this.state === 'starting' && second >= 59) {
                        /*console.debug('setSecond: in case starting at 59');*/
                        this.$second.css('transform', 'rotate(-6deg)');
                    } else if (second === 59) {
                        /*console.debug('setSecond: in case of 59');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                        this.timeout.set(function () {
                            Appanel.clock.$second.removeClass('css-trans');
                            Appanel.clock.$second.css('transform', 'rotate(-6deg)');
                            Appanel.clock.timeout.set(function () {
                                Appanel.clock.$second.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setSecond: in another case');*/
                        this.$second.css('transform', 'rotate(' + (this.percentSecond * 360) + 'deg)');
                    }
                }
                this.second = second;
                this.shadow(this.$second, this.percentSecond);
            },

            setMinute: function (minute) {
                if (this.options.useSweep) {
                    this.percentMinute = (minute + this.percentSecond) / 60;
                } else {
                    this.percentMinute = minute / 60;
                    this.minuteDegree = (this.percentMinute * 360);
                    if (this.state === 'starting' && minute >= 59) {
                        /*console.debug('setMinute: in case starting at 59');*/
                        Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                    } else if (minute === 59) {
                        /*console.debug('setMinute: in case of 59');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                        this.timeout.set(function () {
                            Appanel.clock.$minute.removeClass('css-trans');
                            Appanel.clock.$minute.css('transform', 'rotate(-' + (360 - Appanel.clock.minuteDegree) + 'deg)');
                            Appanel.clock.timeout.set(function () {
                                Appanel.clock.$minute.addClass('css-trans');
                            }, 100);
                        }, 100);
                    } else {
                        /*console.debug('setMinute: in another case');*/
                        this.$minute.css('transform', 'rotate(' + this.minuteDegree + 'deg)');
                    }

                    // update hour hand at every minute
                    if (this.hour !== undefined) this.setHour(this.hour);
                }
                this.minute = minute;
                this.shadow(this.$minute, this.percentMinute);
            },

            setHour: function (hour) {
                this.percentHour = (hour + this.percentMinute) / 12;
                if (!this.options.useSweep) {
                    this.hourDegree = this.percentHour * 360;
                    if (hour === 11) {
                        if (this.hour !== hour) {
                            /*console.debug('setHour: in case of 11');*/
                            this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                            this.timeout.set(function () {
                                Appanel.clock.$hour.removeClass('css-trans');
                                Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                                Appanel.clock.timeout.set(function () {
                                    Appanel.clock.$hour.addClass('css-trans');
                                }, 100);
                            }, 100);
                        } else {
                            /*console.debug('setHour: in case after 11');*/
                            Appanel.clock.$hour.css('transform', 'rotate(-' + (360 - Appanel.clock.hourDegree) + 'deg)');
                        }
                    } else {
                        /*console.debug('setHour: in another case');*/
                        this.$hour.css('transform', 'rotate(' + this.hourDegree + 'deg)');
                    }
                }
                this.hour = hour;
                this.shadow(this.$hour, this.percentHour > 1 ? Math.abs(this.percentHour - 1) : this.percentHour);
            },

            twoDigit: function (number) {
                if (number < 10) return '0' + number;
                return ('' + number).substring(0, 2);
            },

            refreshTime: function () {
                this.ticker.text(this.twoDigit(this.hour) + ':' + this.twoDigit(this.minute) + ':' + this.twoDigit(this.second));
            },

            secondTick: function () {
                var second = this.second + 1;
                if (second >= 60)
                    this.minuteTick();
                else
                    this.setSecond(second);
            },

            minuteTick: function () {
                this.setSecond(0);

                var minute = this.minute + 1;
                if (minute === 60)
                    this.hourTick();
                else
                    this.setMinute(minute);
            },

            hourTick: function () {
                this.setMinute(0);

                var hour = this.hour + 1;
                if (hour === 24)
                    this.setHour(0);
                else
                    this.setHour(hour);
            },

            addProperty: function (theme, name, prop, target) {
                $(theme.add(name, prop, target)).on('css-property:error', function (ev, data) {
                    var title = 'Invalid Color',
                        message = `css-property '${data.property}' not supports the value '${data.value}'`;
                    console.warn(title + ': ', message);
                    Appanel.util.warn(title, message);
                });
            },

            initProfile: function () {
                var theme = new Theme();
                this.addProperty(theme, 'handSecond', ['stroke', 'fill'], $('.second svg'));
                this.addProperty(theme, 'handMinute', ['stroke', 'fill'], $('.minute svg'));
                this.addProperty(theme, 'handHour', ['stroke', 'fill'], $('.hour svg'));
                this.addProperty(theme, 'numbers', ['stroke', 'fill'], $('.numbers svg'));
                this.addProperty(theme, 'timer', ['stroke', 'fill'], $('.ticker'));
                this.addProperty(theme, 'minutes', ['stroke', 'fill'], $('.one.minutes svg'));
                this.addProperty(theme, 'fiveMinutes', ['stroke', 'fill'], $('.five.minutes svg'));
                this.addProperty(theme, 'frame', 'stroke', $('.wrapper > .background svg'));
                this.addProperty(theme, 'background', 'fill', $('.wrapper > .background svg'));
                this.addProperty(theme, 'border', 'stroke-width', $('.wrapper > .background svg'));
                this.addProperty(theme, 'outSide', 'background-color', $('.out-side'));

                theme.add('chandSecond', 'background-color', $('.color-handSecond'), 'handSecond');
                theme.add('chandMinute', 'background-color', $('.color-handMinute'), 'handMinute');
                theme.add('chandHour', 'background-color', $('.color-handHour'), 'handHour');
                theme.add('cnumbers', 'background-color', $('.color-numbers'), 'numbers');
                theme.add('ctimer', 'background-color', $('.color-timer'), 'timer');
                theme.add('cminutes', 'background-color', $('.color-minutes'), 'minutes');
                theme.add('cfiveMinutes', 'background-color', $('.color-fiveMinutes'), 'fiveMinutes');
                theme.add('cframe', 'background-color', $('.color-frame'), 'frame');
                theme.add('cbackground', 'background-color', $('.color-background'), 'background');
                theme.add('coutSide', 'background-color', $('.color-outSide'), 'outSide');

                this.handle(new Profile(this.name, theme, {useSweep: false}));
            },

            sortByName: function (array) {
                array.sort((a, b) => a.name.toUpperCase().localeCompare(b.name.toUpperCase()));
            },

            handle: function (profile) {
                Appanel['profile'] = profile;

                if (!profile.contains('default')) {
                    profile.save('default', {
                        theme: {
                            handSecond: 'red',
                            handMinute: 'orange',
                            handHour: 'gold',
                            numbers: 'gold',
                            minutes: '#000000',
                            fiveMinutes: '#222222',
                            frame: 'silver',
                            background: 'navy',
                            outSide: 'bluesky'
                        },
                        more: {/* @Deprecated */}
                    });
                }

                var e = $('.theme .profile'),
                    container = e.parents('.profile-container'),
                    template = container[0].innerHTML,
                    clockContainer = $('.clock-container'),
                    clockTemplate = clockContainer[0].innerHTML,
                    bgContainer = $('.background-container'),
                    bgTemplate = bgContainer[0].innerHTML,
                    comContainer = $('.combination-container'),
                    comTemplate = comContainer[0].innerHTML,
                    count = profile.ids.length,
                    theme = profile.theme,
                    themeProperty, button, saveButton, editButton, deleteButton;

                // handle movement buttons and browser functions
                Appanel.map([
                    ['.analogue-move', 'click', function () {
                        Appanel.clock.setUseSweep(false);
                    }],
                    ['.smooth-move', 'click', function () {
                        Appanel.clock.setUseSweep(true);
                    }],
                    ['.full-screen', 'click', function (ev) {
                        if (document.fullscreenElement) {
                            if (document.exitFullscreen) {
                                document.exitFullscreen();
                            } else if (document.mozCancelFullScreen) { /* Firefox */
                                document.mozCancelFullScreen();
                            } else if (document.webkitExitFullscreen) { /* Chrome, Safari and Opera */
                                document.webkitExitFullscreen();
                            } else if (document.msExitFullscreen) { /* IE/Edge */
                                document.msExitFullscreen();
                            }
                        } else {
                            if (document.documentElement.requestFullscreen) {
                                document.documentElement.requestFullscreen().catch(err => Appanel.util.warn(`${err.name}`, `${err.message}`));
                            } else if (document.documentElement.mozRequestFullScreen) {
                                document.documentElement.mozRequestFullScreen().catch(err => Appanel.util.warn(`${err.name}`, `${err.message}`));
                            } else if (document.documentElement.webkitRequestFullscreen) {
                                document.documentElement.webkitRequestFullscreen().catch(err => Appanel.util.warn(`${err.name}`, `${err.message}`));
                            } else if (document.documentElement.msRequestFullscreen) {
                                document.documentElement.msRequestFullscreen().catch(err => Appanel.util.warn(`${err.name}`, `${err.message}`));
                            }
                        }
                    }],
                    ['.thin-window', 'click', function () {
                        let features = `left=${window.screenX},top=${window.screenY},width=${window.innerWidth},height=${window.innerHeight},menuber=false,scrollbars=false,status=false,titlebar=false,toolbar=false`,
                            thinWindow;
                        thinWindow = window.open(window.location, '_blank', features);
                        thinWindow.parentWindow = window;
                        thinWindow.onload = function (ev) {
                            let thinWindow = ev.currentTarget;
                            thinWindow.parentWindow = window;
                            thinWindow.Appanel.util.info('This is Thin Window', 'Now, you can resize this window to the smallest size.', 3);
                            thinWindow.parentWindow.close();
                        };
                    }]
                ]);

                // handle combination buttons
                comContainer[0].innerHTML = "";
                for (var i = 0; i < this.combinations.length; i++) {
                    comContainer.append(comTemplate.replace('combination-name', this.combinations[i].name));
                    button = comContainer.find('.combination-item').removeClass('combination-item');
                    saveButton = comContainer.find('.save').removeClass('save');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadCombination(ev.data.index);
                        }, {name: this.combinations[i].name, index: i}],
                        [saveButton, 'click', function (ev) {
                            Appanel.clock.saveCombination(ev.data.name);
                            Appanel.util.info('SAVED', 'Preset : ' + ev.data.name)
                        }, {name: this.combinations[i].name, index: i}]
                    ]);
                }

                // handle add combination button
                Appanel.map([[$('.add-combination'), 'click', function (ev) {
                    Appanel.util.input({title: 'New Preset'}, 'Enter preset name:', Appanel.clock.background,
                        function (data, name) {
                            if (Appanel.clock.combinationIndex(name) >= 0) {
                                Appanel.util.warn('The name ' + name + ' already exists!', 'Try new one that not appear in the list.', 10);
                            } else {
                                Appanel.clock.saveCombination(name);
                                Appanel.util.refresh();
                            }
                        });
                }]]);

                // handle background buttons
                bgContainer[0].innerHTML = "";
                for (var i = 0; i < this.backgrounds.length; i++) {
                    bgContainer.append(bgTemplate.replace('background-name', this.backgrounds[i].name));
                    button = bgContainer.find('.background-item').removeClass('background-item');
                    saveButton = bgContainer.find('.save').removeClass('save');
                    editButton = bgContainer.find('.edit').removeClass('edit');
                    deleteButton = bgContainer.find('.delete').removeClass('delete');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.rotateBackground('stop');
                            Appanel.clock.loadBackground(ev.data.index);
                        }, {name: this.backgrounds[i].name, index: i}],
                        [/*moveClock*/saveButton, 'click', function (ev) {
                            let clock = Appanel.clock,
                                moveTopLeft = function () {
                                    $('#panel-selection')
                                        .css('position', 'fixed')
                                        .css('left', '100vw')
                                        .css('top', '0px')
                                        .css('min-width', '250px')
                                        .css('transform', 'translateX(-100%)');
                                },
                                complete = function (data) {
                                    Appanel.clock.saveBackground(Appanel.clock.background);
                                    Appanel.util.info('Clock Position ' + (data.rotated !== undefined ? ' & Rotation ' : '') + ' Saved', 'Background : ' + Appanel.clock.background)
                                },
                                selection = function (ev, button) {
                                    if (button.button === 'Move Clock') {
                                        ev.data.move(ev.data);
                                    } else if (button.button === 'Rotate Clock') {
                                        ev.data.rotate(ev.data);
                                    } else {
                                        ev.data.complete(ev.data);
                                    }
                                },
                                rotate = function (data) {
                                    data.rotated = true;
                                    Appanel.util.seeNMove(Appanel.clock.backgroundAttributes, 'member', ['clockXDegree', 'clockYDegree', 'clockZDegree', 'clockPerspective', 'clockPerspectiveXOrigin', 'clockPerspectiveYOrigin'], 0.5, {title: 'Rotate Clock', data: data, handler: data.selection, buttons: ['Move Clock', 'Save']});
                                    new Appanel.Timeout(moveTopLeft, 200);
                                },
                                move = function (data) {
                                    Appanel.util.seeNMove(clock.backgroundAttributes, 'member', ['clockXInPercent', 'clockYInPercent', 'clockWInPercent', 'clockHInPercent'], 0.001, {title: 'Move Clock', data: data, handler: data.selection, buttons: ['Rotate Clock', 'Save']});
                                    new Appanel.Timeout(moveTopLeft, 200);
                                },
                                data = {move: move, rotate: rotate, complete: complete, selection: selection};

                            clock.loadBackground(clock.backgroundIndex(ev.data.name));
                            data.data = data;
                            move(data);

                        }, {name: this.backgrounds[i].name, index: i}],
                        [editButton, 'click', function (ev) {
                            let clock = Appanel.clock,
                                background,
                                name = ev.data.name;
                            clock.loadBackground(ev.data.index);
                            background = clock.backgroundAttributes;
                            Appanel.util.inputs({
                                inputs: [
                                    {
                                        label: 'Background Name:',
                                        placeHolder: 'unique name here',
                                        defaultValue: name,
                                        type: 'text'
                                    },
                                    {
                                        label: 'Image File Name:',
                                        placeHolder: 'file name without path',
                                        defaultValue: background.image,
                                        type: 'text'
                                    },
                                    {
                                        label: 'Image Width:',
                                        placeHolder: 'in pixels',
                                        defaultValue: background.imageWidth,
                                        type: 'number'
                                    },
                                    {
                                        label: 'Image Height:',
                                        placeHolder: 'in pixels',
                                        defaultValue: background.imageHeight,
                                        type: 'number'
                                    }
                                ],
                                title: 'Edit Background',
                                data: {clock: clock, name: name},
                                handler: function (data, values) {
                                    let clock = data.clock;
                                    if (clock.backgroundIndex(values[0]) >= 0 && name !== data.name) {
                                        Appanel.util.warn('Duplicate Name', 'Background with the name "' + values[0] + '" is already exists, no background is changed');
                                        return;
                                    }

                                    let index = clock.backgroundIndex(data.name),
                                        background = clock.backgroundAttributes;
                                    clock.backgrounds[index].name = values[0];
                                    clock.background = values[0];
                                    background.name = values[0];
                                    background.image = values[1];
                                    background.imageWidth = parseFloat(values[2]);
                                    background.imageHeight = parseFloat(values[3]);
                                    clock.saveBackground(values[0]);
                                    ev.data.button.html('&nbsp;' + values[0]);
                                    Appanel.util.info('SAVED', 'for background named "' + values[0] + '"');
                                }
                            });
                        }, {name: this.backgrounds[i].name, index: i, button: button}],
                        [deleteButton, 'click', function (ev) {
                            if (Appanel.clock.backgrounds.length <= 1) {
                                Appanel.util.warn('Requires at least one background, if you want to delete this background please add another before.', 15);
                                return;
                            }

                            let dialogue = Appanel.selection('question', 'Delete Background', 'Are you sure you want to delete background "' + ev.data.name + '" this can not undo?', {buttons: ['Yes', 'No']});
                            Appanel.map([[dialogue, 'selection:closed', function (ev, button) {
                                if (button.button === 'Yes') {
                                    let name = ev.data.name,
                                        clock = Appanel.clock,
                                        index = clock.backgroundIndex(name),
                                        buttons = ev.data.buttons;

                                    clock.backgrounds.splice(index, 1);
                                    for (let i in buttons) {
                                        buttons[i].remove();
                                    }

                                    if (name === clock.background) {
                                        clock.loadBackground(0);
                                    }
                                    clock.saveBackground(clock.background);

                                    Appanel.util.info('DELETED', 'Background "' + ev.data.name + '" is deleted.');
                                }
                            }, ev.data]]);
                        }, {name: this.backgrounds[i].name, index: i, buttons: [button, saveButton, editButton, deleteButton]}]
                    ]);
                }

                // handle Auto Change Background button and add background button
                Appanel.map([
                    [$('.auto-change-background'), 'click', function (ev) {
                        Appanel.util.input({title: 'Time Interval'}, 'Enter duration before every change of background (in seconds):', '15',
                            function (data, seconds) {
                                if (!$.isNumeric(seconds)) {
                                    Appanel.util.warn("Invalid Value", "Time interval need number value like 12345, entered value '" + seconds + "' is not a number!", 10);
                                    return;
                                }
                                Appanel.clock.rotateBackground(seconds * 1000);
                            });
                    }],
                    [$('.add-background'), 'click', function (ev) {
                        let clock = Appanel.clock;
                        Appanel.util.inputs({
                            inputs: [
                                {
                                    label: 'Background Name:',
                                    placeHolder: 'unique name here',
                                    defaultValue: '',
                                    type: 'text'
                                },
                                {
                                    label: 'Image File Name:',
                                    placeHolder: 'file name without path',
                                    defaultValue: '',
                                    type: 'text'
                                },
                                {
                                    label: 'Image Width:',
                                    placeHolder: 'in pixels',
                                    defaultValue: 1366,
                                    type: 'number'
                                },
                                {
                                    label: 'Image Height:',
                                    placeHolder: 'in pixels',
                                    defaultValue: 768,
                                    type: 'number'
                                }
                            ],
                            title: 'New Background',
                            data: {clock: clock},
                            handler: function (data, values) {
                                let name = values[0],
                                    clock = data.clock;
                                if (clock.backgroundIndex(name) >= 0) {
                                    Appanel.util.warn('Duplicate Name', 'Background with the name "' + attributes.name + '" is already exists, no background is added');
                                    return;
                                }

                                /*create default background attributes with values*/
                                let attributes = Object.assign({}, clock.defaults.backgroundAttributes, {
                                    name: name,
                                    image: 'img/' + values[1],
                                    imageWidth: parseFloat(values[2]),
                                    imageHeight: parseFloat(values[3])
                                });
                                console.debug("attributes: ", attributes);

                                /*push to backgrounds and then loadBackground by name*/
                                clock.backgrounds.push(attributes);
                                clock.loadBackground(clock.backgroundIndex(name));
                                clock.saveBackground(name);
                                Appanel.util.refresh();
                            }
                        });
                    }]
                ]);

                // handle clock buttons
                clockContainer[0].innerHTML = "";
                for (var i = 0; i < this.clocks.length; i++) {
                    clockContainer.append(clockTemplate.replace('clock-name', this.clocks[i].display));
                    button = clockContainer.find('.clock-item').removeClass('clock-item');
                    Appanel.map([
                        [button, 'click', function (ev) {
                            Appanel.clock.loadClock(ev.data.index, function () {
                                this.updateElements();
                                this.ready();
                            });
                        }, {name: this.clocks[i].name, index: i}]
                    ]);
                    if (this.clocks[i].name === this.clock) button.click();
                }

                // handle profile buttons
                profile.ids.sort((a, b) => a.toUpperCase().localeCompare(b.toUpperCase()));
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    let profileName = profile.ids[i];
                    container.append(template.replace('profile-name', profileName));
                    button = container.find('.profile').removeClass('profile').addClass('profile-' + profileName);
                    Appanel.map([
                        [button, 'click', function (ev) {
                            var profile = Appanel.profile.load(ev.data.profile),
                                profileName = $('.profile-name');
                            Appanel.clock.ui.refreshCurrentInfo();
                            profileName[0].innerText = ev.data.profile;
                            profileName[0].title = 'Current Theme : ' + ev.data.profile;
                        }, {theme: profile.theme, profile: profileName}]
                    ]);
                    if (profileName === profile.current) button.click();
                }

                // handle add profile button
                Appanel.map([[$('.theme .add-profile'), 'click', function (ev) {
                    Appanel.util.input({title: 'New Theme'}, 'Enter theme name:', Appanel.clock.background,
                        function (data, name) {
                            if (Appanel.profile.contains(name)) {
                                Appanel.util.warn(name + ' theme already exists!', 'Try again with another name that not in the list.', 10);
                            } else {
                                Appanel.profile.save(name);
                                Appanel.profile.setCurrent(name);
                                Appanel.util.refresh();
                            }
                        });
                }]]);

                // handle profile name button
                button = $('.theme .profile-name');
                Appanel.map([[button, 'click', function (ev) {
                    var oldName = ev.currentTarget.innerText;
                    Appanel.util.input({title: 'Change Theme Name'}, 'Enter new name:', oldName,
                        function (data, newName) {
                            if (Appanel.profile.contains(newName)) {
                                alert('Profile ' + newName + ' already exists!');
                            } else {
                                Appanel.profile.save(newName);
                                Appanel.profile.remove(data.oldName);
                                Appanel.profile.setCurrent(newName);
                                Appanel.util.refresh();
                            }
                        }, {oldName: oldName});
                }]]);

                // handle color buttons
                var colorPanel = $('.theme .colors'),
                    title;
                for (var i in theme) {
                    themeProperty = theme[i];
                    if (i.startsWith('jQuery') || $.isArray(themeProperty) || themeProperty.constructor === Function || themeProperty.sourceProperty != null) continue;
                    button = colorPanel.find('.color-' + i);
                    title = button[0].innerText;
                    Appanel.map([
                        [button, 'click', function (ev) {
                            let property = ev.data.property,
                                propertyName = property.prop;
                            Appanel.util.input({title: ev.data.title}, 'Enter ' + propertyName + ' attribute value:', property.get(),
                                function (data, color) {
                                    data.property.set(color);
                                    Appanel.profile.save(Appanel.profile.current);
                                }, {property: ev.data.property});
                        }, {title: title, property: themeProperty}]
                    ]);
                }
            },

            clearSweep: function ($element, callback) {
                var e, $e, length = $element.length;
                if (length == 0) {
                    console.warn('Ignore clearSweep with zero length');
                    return;
                }

                for (let i = 0; i < $element.length; i++) {
                    e = $element[i];
                    delete e.sweepID;
                    delete e.sweepContext;
                    delete e.chainsID;
                    $e = $(e)
                        .removeClass('ani-clock')
                        .removeClass('css-trans')
                        .css('transform', '')
                        .css('animation-duration', '')
                        .css('animation-iteration-count', '')
                        .css('animation-timing-function', '');
                    Appanel.chains($e, 'ani-clock-reset:0.001');
                }

                if (callback !== undefined) Appanel.clock.timeout.set(function () {
                    callback.call(Appanel.clock);
                }, 10);

                return this;
            },

            updateElements: function () {
                this.$second = $(this.$second.selector);
                this.$minute = $(this.$minute.selector);
                this.$hour = $(this.$hour.selector);
                this.sweeper = $(this.sweeper.selector);
                Appanel.profile.theme.updateElements();
            },

            stop: function (callback) {
                if (this.state !== 'started') {
                    console.warn('Ignore stop at the state', this.state);
                    if (callback !== undefined) callback.call(this);
                    return;
                }

                this.state = 'stopping';
                console.info("clock stop at ", this.hour, ":", this.minute, ":", this.second, ' ', this.options.speed, 'X speed');

                this.interval.clear();
                this.timeout.clear();

                this.setSecond(this.second);
                this.setMinute(this.minute);
                this.setHour(this.hour);

                this.sweeper
                    .off('sweep:ready')
                    .sweep('pause');
                this
                    .clearSweep(this.sweeper)
                    .clearSweep(this.secondHand)
                    .clearSweep(this.minuteHand)
                    .clearSweep(this.hourHand, function () {
                        Appanel.clock.state = 'stop';
                        callback.call(Appanel.clock);
                    });
            },

            start: function (now, speed) {
                var clock = Appanel.clock,
                    sweepAgain = clock.state === 'started' && clock.$second[0].sweepID !== undefined;

                /*avoid invalid second when start after started*/
                if (clock.state === 'started') {
                    console.info('Start at the state', this.state, ' then restart');
                    clock.stop(function () {
                        clock.start(now, speed);
                    });
                    return;
                }

                if (sweepAgain) {
                    clock.stop.call(clock, function () {
                        this.postStart(now, speed);
                    });
                } else {
                    this.postStart(now, speed);
                }
            },

            postStart: function (now, speed) {
                var hour = now.getHours(),
                    minute = now.getMinutes(),
                    second = now.getSeconds(),
                    clock = Appanel.clock,
                    useSweep = clock.options.useSweep,
                    restart = clock.state === 'started';

                clock.state = 'starting';

                if (speed === undefined) speed = 1;
                clock.options.speed = speed;
                console.info("clock start at ", hour, ":", minute, ":", second, ' ', speed, 'X speed');

                clock.ticker = $('.ticker');
                clock.$second = $('.second');
                clock.$minute = $('.minute');
                clock.$hour = $('.hour');
                clock.sweeper = $('.hour,.minute,.second');
                clock.hourHand = clock.$hour.find('svg');
                clock.minuteHand = clock.$minute.find('svg');
                clock.secondHand = clock.$second.find('svg');

                if (useSweep) {
                    var options = {
                        duration: 0.00001,
                        on: "sweep:ready",
                        sweep: []
                    };

                    //1round = 12hours = 60s x 60 x 12 (loop=1day=2rounds)
                    options.sweep.push(this.getSweeper(clock.hourHand, 'ani-clock', 43200, 2));

                    //1round = 60minutes = 60s x 60 (loop=1day=12rounds)
                    options.sweep.push(this.getSweeper(clock.minuteHand, 'ani-clock', 3600, 12));

                    //1round = 1minutes = 60s (loop=1day=43200rounds)
                    options.sweep.push(this.getSweeper(clock.secondHand, 'ani-clock', 60, 3600));

                    clock.sweep = options;
                }

                // force move clock hands
                Appanel.clock.options.useSweep = false;
                clock.setSecond(second);
                clock.setMinute(minute);
                clock.setHour(hour);
                Appanel.clock.options.useSweep = useSweep;

                // delay start
                let delayStart = function () {
                    let clock = Appanel.clock;
                    clock.secondTick();
                    clock.refreshTime();

                    if (clock.options.useSweep) {
                        clock.sweeper
                            .removeClass('css-trans')
                            .sweep(clock.sweep)
                            .sweep('speedx', clock.options.speed);
                    } else {
                        clock.sweeper.addClass('css-trans');
                    }

                    clock.interval.set(function () {
                        this.secondTick();
                        this.refreshTime();
                    }, 1000 * (1 / clock.options.speed), clock);

                };
                Appanel.clock.timeout.set(delayStart, 1000 - now.getMilliseconds());

                clock.state = 'started';
            },

            getSweeper: function (selector, play, duration, loop) {
                return {
                    selector: selector,
                    play: play,
                    timing: 'linear',
                    duration: duration,
                    loop: loop
                };
            },

            clocks: [],

            clockIndex: function (name) {
                var clocks = this.clocks;
                for (var i = 0; i < clocks.length; i++) {
                    if (clocks[i].name === name) return i;
                }
                return 0;
            },

            loadClock: function (clockIndex, callback) {
                var clock = this.clocks[clockIndex],
                    requestDate = (new Date()).toLocaleTimeString(),
                    clockName = clock.name,
                    url = Appanel.util.myURL() + '-' + clockName + '.html?v=' + requestDate;

                if (clockName === this.clock) {
                    if (callback !== undefined) {
                        console.warn('Skipped, load current clock again is not allowed then run callback immediately.');
                        Appanel.clock.timeout.set(function () {
                            callback.call(Appanel.clock);
                        }, 100);
                    } else
                        console.warn('Skipped, load current clock again is not allowed and no callback to run.');
                    return;
                }

                this.clock = clockName;
                Appanel.set(this.name + ':clock', clockName);
                this.ui.refreshCurrentInfo();

                // test: get clock from first element
                console.info("Clock URL: ", url);
                $.get(url).complete(function (result, status) {
                    var clockHtml = result.responseText,
                        headStart = clockHtml.indexOf('<head>'),
                        headEnd = clockHtml.indexOf('</head>') + 7,
                        $cover = $('.cover');

                    console.info('load clock completed at ', new Date().toLocaleTimeString());
                    clockHtml = clockHtml.substring(0, headStart) + clockHtml.substring(headEnd + 1);
                    $cover.find('.wrapper > .foreground').html(clockHtml);

                    if (callback !== undefined) {
                        Appanel.clock.timeout.set(function () {
                            callback.call(Appanel.clock);
                        }, 100);
                    }
                });
            },

            backgrounds: [],

            backgroundIndex: function (name) {
                var backgrounds = this.backgrounds;
                for (var i = 0; i < backgrounds.length; i++) {
                    if (backgrounds[i].name === name) return i;
                }
                return -1;
            },

            loadBackground: function (backgroundIndex) {
                if (backgroundIndex < 0 || backgroundIndex >= this.backgrounds.length) {
                    if (this.backgroundAttributes === undefined) {
                        backgroundIndex = 0;
                    } else {
                        Appanel.util.error('ERROR', 'backgroundIndex ' + backgroundIndex + ' is out of bound, possible index are 0 - ' + (this.backgrounds.length + 1));
                        backgroundIndex = 0;
                    }
                }

                var bgName = this.backgrounds[backgroundIndex].name;
                this.background = bgName;
                Appanel.set(this.name + ':background', bgName);
                this.ui.refreshCurrentInfo();

                this.setAttributes(this.backgrounds[backgroundIndex]);
            },

            saveBackground: function (name) {
                var index = this.backgroundIndex(name),
                    attributes = Object.assign({}, this.defaults.backgroundAttributes, this.backgroundAttributes),
                    needSort = false;
                if (index < 0) {
                    this.backgrounds.push({});
                    index = this.backgrounds.length - 1;
                    needSort = true;
                }
                this.backgrounds[index] = Object.assign({
                    name: name,

                    imageWidth: attributes.imageWidth,
                    imageHeight: attributes.imageHeight,
                    imageFilter: attributes.imageFilter,

                    clockXInPercent: attributes.clockXInPercent,
                    clockYInPercent: attributes.clockYInPercent,

                    clockWInPercent: attributes.clockWInPercent,
                    clockHInPercent: attributes.clockHInPercent,

                    clockXDegree: attributes.clockXDegree,
                    clockYDegree: attributes.clockYDegree,
                    clockZDegree: attributes.clockZDegree,

                    clockPerspective: attributes.clockPerspective,
                    clockPerspectiveXOrigin: attributes.clockPerspectiveXOrigin,
                    clockPerspectiveYOrigin: attributes.clockPerspectiveYOrigin
                }, (attributes.image === undefined) ? {video: attributes.video} : {image: attributes.image});
                if (needSort) this.sortByName(this.backgrounds);
                Appanel.util.removeSameValue(this.defaults.backgroundAttributes, this.backgrounds[index]);
                Appanel.set(this.name + ':backgrounds', this.backgrounds);
            },

            rotateBackgroundInterval: null,

            rotateBackground: function (secondsOrStop, startFrom) {
                if (startFrom !== undefined) {
                    this.loadBackground(startFrom);
                }

                if (secondsOrStop !== undefined) {
                    if (this.rotateBackgroundInterval != null) clearInterval(this.rotateBackgroundInterval);
                    if (secondsOrStop === 'stop') return;
                    this.rotateBackgroundInterval = setInterval(function () {
                        Appanel.clock.rotateBackground.call(Appanel.clock);
                    }, secondsOrStop);
                    return;
                }

                var bgIndex = (startFrom === undefined ? this.backgroundIndex(this.background) : startFrom) + 1;
                if (bgIndex < 0 || bgIndex >= this.backgrounds.length) bgIndex = 0;
                if (startFrom === undefined) this.loadBackground(bgIndex);
            },

            /**
             * Set Background Attributes.
             *
             * Example:
             * Appanel.clock.setAttributes({
             *      image: 'img/swiss-railway-clock-scaled.webp',
             *      imageWidth: 2560,
             *      imageHeight: 1707,
             *      imageFilter: 0.25,
             *
             *      clockYInPercent: 0.311,
             *      clockWInPercent: 0.25,
             *
             *      clockXInPercent: 0.5715,
             *      clockHInPercent: 0.37
             * });
             */
            setAttributes: function (attrib) {
                if (this.backgroundAttributes !== undefined) $(window).off('resize', this.backgroundAttributes.resize);

                var $cover = $('.cover'),
                    $background = $('.background-image')
                        .removeClass('css-trans')
                        .css('background-repeat', 'no-repeat'),
                    attributes = Object.assign({}, this.defaults.backgroundAttributes, attrib);

                this.backgroundAttributes = Object.assign({
                    ui: this.ui,
                    zoomer: $('body'),
                    background: $background,
                    cover: $cover,
                    rotator: $cover.find('.wrapper'),
                    clock: $cover.find('.clock'),
                    resize: function () {
                        var clock = Appanel.clock,
                            a = clock.backgroundAttributes,
                            currentZoom = '' + clock.ui.zoom.currentZoom.toPrecision(10),
                            normalZoom = '' + (1.0).toPrecision(10),
                            //isNormalZoom = (parseFloat(clock.ui.zoom.currentZoom) <= 1.0);
                            isNormalZoom = (currentZoom <= normalZoom);

                        /* scale <= 0 when zoom == 1
                         * scale > 0 when zoom > 1
                         **/
                        if (isNormalZoom) a.scale = parseFloat(normalZoom);
                        else a.scale = parseFloat(currentZoom);
                        a.relativeScale = a.scale - 1.0;
                        a.imageScaleWidth = a.imageWidth * a.scale;
                        a.imageScaleHeight = a.imageHeight * a.scale;

                        a.screenW = window.innerWidth;
                        a.screenH = window.innerHeight;

                        a.ratioW = a.screenW / a.imageScaleWidth;
                        a.ratioH = a.screenH / a.imageScaleHeight;

                        if (a.ratioW >= a.ratioH) {
                            if (isNormalZoom) {
                                a.ui.debug('case W1:');
                                a.imageX = 0;
                                a.imageY = (a.screenH - (a.ratioW * a.imageHeight)) / 2;
                                a.imageWide = a.screenW;
                                a.imageTall = a.imageHeight * a.ratioW;
                                a.backgroundSize = a.imageWide;
                                a.coverX = a.clockXInPercent * a.screenW;
                                a.coverY = a.imageY + (a.ratioW * a.imageHeight * a.clockYInPercent);
                                /*Notice: a.coverSize = (100 * a.clockWInPercent) + 'vw';*/
                                //a.coverSize = (100 * a.clockWInPercent) * a.screenW * 0.01;
                                a.coverSize = (100 * a.clockHInPercent) * a.imageTall * 0.01;
                            } else {
                                a.ui.debug('case W2:');
                                a.scale = a.ratioW /* this ratioW is max of real scale when the user scale === 1 */ + a.relativeScale;
                                a.imageScaleWidth = a.imageWidth * a.scale;
                                a.imageScaleHeight = a.imageHeight * a.scale;

                                a.imageWide = a.imageScaleWidth;
                                a.imageTall = a.imageScaleHeight;
                                a.backgroundSize = a.imageWide;
                                a.imageX = (a.screenW - a.imageScaleWidth) / 2;
                                a.imageY = (a.screenH - a.imageScaleHeight) / 2;
                                a.coverX = a.imageX + (a.imageWide * a.clockXInPercent);
                                a.coverY = a.imageY + (a.imageTall * a.clockYInPercent);
                                /*Notice: a.coverSize = (100 * a.clockHInPercent) + 'vh';*/
                                a.coverSize = (100 * a.clockHInPercent) * a.imageTall * 0.01;
                            }

                        } else {
                            if (isNormalZoom) {
                                a.ui.debug('case H1:');
                                a.imageWide = a.imageWidth * a.ratioH;
                                a.imageTall = a.imageWide * a.imageScaleWidth / a.imageScaleHeight;
                                a.backgroundSize = a.imageWide;
                                a.imageX = (a.screenW - (a.ratioH * a.imageWidth)) / 2;
                                a.imageY = 0;
                                a.coverX = a.imageX + (a.ratioH * a.imageWidth * a.clockXInPercent);
                                a.coverY = a.clockYInPercent * a.screenH;
                                /*Notice: a.coverSize = (100 * a.clockHInPercent) + 'vh';*/
                                a.coverSize = (100 * a.clockHInPercent) * a.screenH * 0.01;
                            } else {
                                a.ui.debug('case H2:');
                                a.scale = a.ratioH /* this ratioH is max of real scale when the user scale === 1 */ + a.relativeScale;
                                a.imageScaleWidth = a.imageWidth * a.scale;
                                a.imageScaleHeight = a.imageHeight * a.scale;

                                a.imageWide = a.imageScaleWidth;
                                a.imageTall = a.imageScaleHeight;
                                a.backgroundSize = a.imageWide;
                                a.imageX = (a.screenW - a.imageScaleWidth) / 2;
                                a.imageY = (a.screenH - a.imageScaleHeight) / 2;
                                a.coverX = a.imageX + (a.imageWide * a.clockXInPercent);
                                a.coverY = a.imageY + (a.imageTall * a.clockYInPercent);
                                /*Notice: a.coverSize = (100 * a.clockHInPercent) + 'vh';*/
                                a.coverSize = (100 * a.clockHInPercent) * a.imageTall * 0.01;
                            }
                        }

                        /*use relativeX to make equal space between left and right*/
                        let coverSpace = {
                            left: a.coverX,
                            right: (a.coverX + a.coverSize - a.screenW) * -1,
                            top: a.coverY,
                            bottom: (a.coverY + a.coverSize - a.screenH) * -1
                        };
                        if (a.disableRelativeX || coverSpace.left === coverSpace.right) {
                            a.relativeX = 0;
                        } else {
                            /*Notice: let backgroundSpace = {
                            left: a.imageX * -1,
                            right: a.imageX + a.imageWide - a.screenW
                        };*/
                            coverSpace.target = (coverSpace.left + coverSpace.right) / 2;
                            coverSpace.moveLeft = coverSpace.left > coverSpace.right;
                            if (coverSpace.moveLeft) {
                                backgroundSpace = a.imageX * -1;
                                a.relativeX = Math.min(coverSpace.left - coverSpace.target, backgroundSpace, coverSpace.left) * -1;
                            } else {
                                backgroundSpace = a.imageX + a.imageWide - a.screenW;
                                a.relativeX = Math.min(coverSpace.right - coverSpace.target, backgroundSpace, coverSpace.right);
                            }
                        }

                        /*use relativeY to make equal space between top and bottom*/
                        if (a.disableRelativeY || coverSpace.top === coverSpace.bottom) {
                            a.relativeY = 0;
                        } else {
                            /*Notice: let backgroundSpace = {
                            top: a.imageY * -1,
                            bottom: a.imageY + a.imageTall - a.screenH
                        };*/
                            coverSpace.target = (coverSpace.top + coverSpace.bottom) / 2;
                            coverSpace.moveUp = coverSpace.top > coverSpace.bottom;
                            if (coverSpace.moveUp) {
                                backgroundSpace = a.imageY * -1;
                                a.relativeY = Math.min(coverSpace.top - coverSpace.target, backgroundSpace, coverSpace.top) * -1;
                            } else {
                                backgroundSpace = a.imageY + a.imageTall - a.screenH;
                                a.relativeY = Math.min(coverSpace.bottom - coverSpace.target, backgroundSpace, coverSpace.bottom);
                            }
                        }

                        a.background
                            .css('left', (a.imageX + a.relativeX) + 'px')
                            .css('top', (a.imageY + a.relativeY) + 'px')
                            .css('background-size', a.backgroundSize + 'px')
                            .css('width', a.imageWide + 'px')
                            .css('height', a.imageTall + 'px');

                        if (a.clockPerspective <= 0) {
                            a.cover.css('transform-style', 'flat');
                        } else {
                            let originX = a.clockPerspectiveXOrigin,
                                originY = a.clockPerspectiveYOrigin;
                            if (originX === 0 && originY === 0) {
                                originX = originY = a.coverSize / 2;
                            }
                            a.cover
                                .css('transform-style', 'preserve-3d')
                                .css('transform-origin', originX + 'px ' + originY + 'px')
                                .css('transform', 'perspective(' + a.clockPerspective + 'px)');
                        }

                        a.cover
                            .css('left', (a.coverX + a.relativeX) + 'px')
                            .css('top', (a.coverY + a.relativeY) + 'px');

                        a.rotator
                            .css('transform', 'rotate3d(1,0,0,' + a.clockXDegree + 'deg) rotate3d(0,1,0,' + a.clockYDegree + 'deg) rotate3d(0,0,1,' + a.clockZDegree + 'deg)');

                        a.clock
                            .css('width', a.coverSize + 'px')
                            .css('height', a.coverSize + 'px');

                        $(clock).trigger('clock:resize');
                    },
                    member: function (memberName, value) {
                        if (value === undefined) {
                            /* GET VALUE */
                            return this[memberName];
                        } else {
                            /* SET VALUE */
                            this[memberName] = value;
                            this.resize();
                        }
                    }
                }, attributes);

                /*clock shape/background and frame*/
                var $shapes = $cover.find('.shape').css('display', 'none'),
                    $shape = $shapes.filter('#' + attributes.clockShape.id).css('display', 'inline'),
                    shape = Object.assign({}, attributes.clockShape),
                    theme = Appanel.profile === undefined ? undefined : Appanel.profile.theme;
                for (var i in shape) $shape.attr(i, shape[i]);
                if (theme !== undefined) {
                    theme.frame.updateElement();
                    theme.background.updateElement();
                    theme.refresh();
                }

                if (attributes.image === undefined) {
                    $background.css('background-image', '').find('video').remove();
                    $background.prepend('<video autoplay muted loop class="fit-width on-top-left">' +
                        '    <source src="' + attributes.video + '" type="video/mp4">' +
                        '</video>');
                } else {
                    $background
                        .css('background-image', 'url(' + attributes.image + ')')
                        .find('video').remove();
                }

                $('.out-side').css('opacity', this.backgroundAttributes.imageFilter);

                $(window).on('resize', this.backgroundAttributes.resize);
                this.backgroundAttributes.resize();
            },

            combinations: [],

            combinationIndex: function (name) {
                var combinations = this.combinations;
                for (var i = 0; i < combinations.length; i++) {
                    if (combinations[i].name === name) return i;
                }
                return -1;
            },

            loadCombination: function (combinationIndex) {
                var combination = this.combinations[combinationIndex];
                this.combination = combination.name;
                Appanel.util.disableRefresh = true;

                this.loadClock(this.clockIndex(combination.clock), function () {
                    this.updateElements();
                    Appanel.profile.theme.updateElements();

                    this.start(new Date());

                    this.options = Object.assign({}, this.defaults.options);
                    if (combination.options !== undefined) {
                        this.options = Object.assign(this.options, combination.options);
                    }
                    this.saveOptions();
                    this.loadOptions();

                    this.loadBackground(this.backgroundIndex(combination.background));
                    $('.clock').css('display', 'block');

                    Appanel.profile.load(combination.theme);
                    $('.profile-name').text(combination.theme);

                    Appanel.util.disableRefresh = false;
                    this.ui.refreshCurrentInfo();
                });
            },

            saveCombination: function (name) {
                var index = this.combinationIndex(name),
                    needSort = false;
                if (index < 0) {
                    this.combinations.push({});
                    index = this.combinations.length - 1;
                    needSort = true;
                }
                this.combinations[index] = {
                    name: name,
                    clock: this.clock,
                    theme: Appanel.profile.current,
                    background: this.background,
                    options: this.options
                };
                if (needSort) this.sortByName(this.combinations);
                Appanel.set(this.name + ':combinations', this.combinations);
            },

            loadJSONLocal: function (name, callback) {
                var localName = this.name + ':' + name,
                    json = Appanel.get(localName);
                if (json == null) return false;

                this[name] = json;
                if ($.isFunction(callback)) callback.call(this, localName);
                return true;
            },

            loadJSON: function (name, callback) {
                if (name !== 'control' && this.control[name] <= this.defaults.control[name]) {
                    if (this.loadJSONLocal(name, callback)) return;
                }

                var requestDate = (new Date()).toLocaleTimeString(),
                    uri = Appanel.util.myURL() + '-' + name + '.json',
                    myJson = encodeURI(uri + '?v=' + requestDate);

                //console.info("JSON URL: ", myJson);
                this.lastLoadJSON = $.getJSON(myJson)
                    .complete(function (json, status) {
                        //console.info('load ', name, 'completed at ', new Date().toLocaleTimeString());
                        Appanel.clock[name] = json.responseJSON;
                        Appanel.set(Appanel.clock.name + ':' + name, json.responseJSON);
                        if ($.isFunction(callback)) callback.call(Appanel.clock, uri);
                    });
                this.lastLoadJSON.fail(function (ev) {
                    //console.error('load ', name, 'failed at ', new Date().toLocaleTimeString(), ':', ev.status, ev.statusText);
                    Appanel.util.error('ERROR', 'load ' + name + ' json failed with ' + ev.status + ':' + ev.statusText, 30);
                    Appanel.clock[name] = Appanel.clock.defaults[name];

                    var loadStatus = ev.status;
                    if (Appanel.clock.defaults[name] !== undefined) {
                        loadStatus = 'default';
                    } else {
                        loadStatus = status /*ev.status*/;
                    }

                    if ($.isFunction(callback)) callback.call(Appanel.clock, loadStatus);
                });
            },

            init: function () {
                this.timeout = new Appanel.Timeout();
                this.interval = new Appanel.Interval();

                var control = Appanel.get(this.name + ':control');
                if (control !== null) this.defaults.control = control;

                this.loadOptions();
                this.loadJSON('control', function (status) {
                    console.info('Control loaded from ' + status);
                    this.loadJSON('clocks', function (status) {
                        if (status === 'parsererror') {
                            this.clocks = [];
                            Appanel.util.error('IMPORTANT', 'load clock list failed the "' + Appanel.util.myURL() + '-clocks.json" may be corrupted', 20);
                            return;
                        }
                        console.info('Clocks loaded from ' + status);
                        this.sortByName(this.clocks);
                        this.loadClock(this.clockIndex(Appanel.get(this.name + ':clock')), Appanel.clock.ready);
                    });
                    this.loadJSON('backgrounds', function (status) {
                        if (status === 'parsererror') {
                            this.backgrounds = [];
                            Appanel.util.error('IMPORTANT', 'load background list failed the "' + Appanel.util.myURL() + '-backgrounds.json" may be corrupted', 20);
                            return;
                        }
                        console.info('Backgrounds loaded from ' + status);
                        this.sortByName(this.backgrounds);
                    });
                    this.loadJSON('combinations', function (status) {
                        if (status === 'parsererror') {
                            this.backgrounds = [];
                            Appanel.util.error('IMPORTANT', 'load combination list failed the "' + Appanel.util.myURL() + '-combinations.json" may be corrupted', 20);
                        }
                        console.info('Combinations loaded from ' + status);
                        this.sortByName(this.combinations);
                    });
                });

                this.ui.init();
            },

            createMinutes: function (container, degrees, count) {
                var template = container[0].innerHTML;
                container[0].innerHTML = "";
                for (var i = 0; i < count; i++) {
                    if (degrees[i] === 0) continue;
                    container.append(template.replace('number-id', 'number-' + i));
                    container.find('.number-' + i).css('transform', 'rotate(' + degrees[i] + 'deg)');
                }
            },

            timeDiff: function (date) {
                let diff = (date.getHours() - this.hour) * 3600;
                diff += (date.getMinutes() - this.minute) * 60;
                return diff + date.getSeconds() - this.second;
            },

            disableActivated: false,

            activated: function () {
                let clock = Appanel.clock;
                if (clock.disableActivated) {
                    console.warn('Ignore activated by switch disableActivated is ', clock.disableActivated);
                    return;
                }

                if (Math.abs(clock.timeDiff(new Date())) < 3) {
                    console.warn('Ignore activated by timeDiff less than 3s');
                    return;
                }

                clock.loadClock(clock.clockIndex(clock.clock), function () {
                    clock.updateElements();
                    clock.ready();
                });

                /*Appanel.clock.stop(function () {
                    Appanel.clock.start(new Date(), Appanel.clock.options.speed);
                });*/
            },

            ready: function () {
                var firstTime = this.state === 'initialized';
                this.start(new Date());
                /*this.start(new Date(2022, 12, 25, 17, 59, 59), 1);*/

                // need to show after started
                this.loadBackground(this.backgroundIndex(Appanel.get(this.name + ':background')));
                this.loadOptions();
                $('.clock').css('display', 'block');

                if (firstTime) {
                    this.initProfile();
                    $(window).on('focus', this.activated);
                } else {
                    Appanel.profile.load(Appanel.profile.current);
                }
            }

        },

        ready: function () {
            Appanel.clock.init();
            Appanel.util.refreshEvery(300, Appanel.clock.activated, Appanel.clock);
        }
    });
</script>

</body>
</html>
